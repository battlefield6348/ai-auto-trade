# 台灣股票資料取得（Data Ingestion）功能規格

版本：v1.0  
狀態：草稿  
最後更新：2025-12-02

---

## 1. 功能簡介

本文件定義「台灣股票資料取得（Data Ingestion）」功能之產品需求與行為規格，作為後端系統實作與測試依據。

本功能目標：  
建立一個可靠、可排程、可回補、可監控的「台灣股票市場原始資料收集層」，供後續各種批次分析與策略模組使用。

---

## 2. 範圍與非範圍

### 2.1 功能範圍（In Scope）

- 取得並儲存台灣股票市場「日階層」相關資料：
  - 上市（TWSE）股票日 K（開、高、低、收、成交量等）
  - 上櫃（TPEx）股票日 K
  - 股票基本資料（代碼、名稱、上市別、產業別等）
  - 股票狀態（上/下市、暫停交易等基本旗標）
- 支援三種操作模式：
  1. 每日例行排程抓取「最新一個交易日」資料
  2. 指定日期區間的資料回補（backfill）
  3. 指定單一或多檔股票的資料重抓（recovery）
- 基本資料清洗與驗證（欄位完整性、數值合理性等）
- 對內統一資料格式輸出（供分析層使用）
- 失敗重試、錯誤紀錄與結果報告（log / 狀態紀錄）

### 2.2 非功能範圍（Out of Scope，在 v1 不處理）

- 盤中即時報價（tick、分 K）
- 衍生性商品（期貨、選擇權等）
- 海外股票市場資料
- 技術指標計算（MA、MACD 等）與任何投資策略邏輯
- 任何對外提供 API 的介面（v1 僅對內服務）

---

## 3. 使用情境與角色

### 3.1 角色定義

- 系統運維/工程師（Internal Dev/Ops）
  - 設定排程、觸發回補、監控資料抓取狀態
- 分析模組（下游系統 / Service）
  - 消費本資料取得模組所產生的結構化資料

### 3.2 主要使用情境

1. 每個交易日晚上，自動抓取當日所有台股日 K 與相關基本資料，供隔日分析、回測、報表使用。
2. 針對新部署環境或歷史資料不完整情況，一次性回補某個時間區間（例如 2015-01-01 至 2020-12-31）的日 K 資料。
3. 當某些股票因網路、來源異常等導致資料缺漏或錯誤時，可以針對單一/多檔股票重新抓取其歷史資料。

---

## 4. 資料需求

### 4.1 目標資料類型

1. 日 K 資料（股票 × 日期）
   - 必要欄位（邏輯層面）：
     - 股票代碼
     - 市場別（上市/上櫃）
     - 交易日期
     - 開盤價
     - 最高價
     - 最低價
     - 收盤價
     - 成交量
     - 成交筆數（若來源提供）
     - 成交金額（若來源提供）
     - 漲跌價差
     - 漲跌幅（若來源提供）
     - 是否為除權息日、是否遇到漲跌停（若來源可判斷，可先預留欄位）

2. 股票基本資料
   - 股票代碼
   - 股票名稱（中文，必要）
   - 英文名稱（若有）
   - 市場別（上市、上櫃）
   - 產業別
   - 上市/上櫃日期
   - 股票狀態（正常、下市、暫停交易、恢復交易等）
   - 是否為 ETF、ETN、債券等（若來源可辨識，可透過種類欄位表示）

3. 輔助資料（若來源允許）
   - 除權息基礎資訊（除息日、配息金額、配股數量等）
   - 漲跌停價格（可選，v1 可不強制）

### 4.2 資料來源需求

- 必須支援至少一個官方或權威資料來源（如交易所/櫃買中心等）。
- 必須能對資料來源異常做錯誤處理與告警，不可默默失敗。
- 若未來增加其他資料來源，應可透過配置/擴充，無需重寫現有流程。

---

## 5. 功能行為規格

### 5.1 每日例行抓取

#### 5.1.1 排程時間（台北時間）

- 正式環境：每個「交易日」的當日 18:15 啟動一次例行抓取任務。
- 交易日定義：
  - 預設依「台灣證券交易所公布的交易日」為準。
  - v1 可透過簡單策略處理（例如排除週末與已知國定假日），未來可再獨立一份「交易日曆」模組。
- 若 18:15 任務失敗，須至少再自動重試 2 次：
  - 第一次重試：18:30
  - 第二次重試：18:45

#### 5.1.2 行為流程

1. 判斷今日是否為交易日：
   - 若非交易日，直接記錄「非交易日不執行抓取」，任務結束。
2. 取得「今日」所有上市/上櫃股票清單。
3. 對每一檔股票，取得該股票「今日日 K」資料。
4. 執行資料清洗與驗證（見 6.1）。
5. 將有效資料寫入儲存層。
6. 統計本次執行結果（成功筆數、失敗檔數、耗時等）並寫入紀錄。
7. 若存在失敗股票，須紀錄失敗清單，供後續重抓或告警使用。

### 5.2 資料回補（Backfill）

#### 5.2.1 使用情境

- 新環境第一次建置時，需要回補數年歷史資料。
- 部分期間資料有缺漏，需要指定日期區間重抓。

#### 5.2.2 操作方式

- 可由運維/工程師透過任意介面（例如內部工具、排程設定等）指定：
  - 開始日期
  - 結束日期
  - 可選：限制市場（僅上市、僅上櫃或全部）
  - 可選：限制股票清單（空白則為全部股票）

#### 5.2.3 排程建議

- 預設建議在每日 02:00 執行回補排程（若有待執行之回補任務）。
- 回補任務需支援批次拆分與限流，避免壓垮外部資料來源或內部 DB。

### 5.3 單股/少量股票重抓（Recovery）

#### 5.3.1 使用情境

- 某檔股票在某些日期資料異常或缺失，需要重抓。
- 檢測到部分股票連續數日資料明顯不合理（例如全為 0 或全部相同價格）。

#### 5.3.2 操作方式

- 可由運維/工程師指定：
  - 股票代碼（可一次多檔）
  - 日期區間（至少一日）
- 系統需支援：
  - 重抓後可選擇「覆蓋既有資料」或「僅在原資料不存在時才寫入」，預設為覆蓋。

---

## 6. 資料品質與驗證

### 6.1 基本驗證規則

對每筆日 K 資料，至少需檢查：

- 必填欄位不得為空：
  - 股票代碼、交易日期、開高低收、成交量
- 價格欄位需符合以下基本條件：
  - 開盤價、最高價、最低價、收盤價皆須 ≥ 0
  - 最高價 ≥ max(開盤價, 收盤價, 最低價)
  - 最低價 ≤ min(開盤價, 收盤價, 最高價)
- 成交量、成交金額不得為負數。
- 同一「股票 × 日期」不得出現重複主鍵資料：
  - 若已存在資料且本次策略為「覆蓋」，則以本次資料為準。
  - 若策略為「不覆蓋」，則略過寫入並紀錄。

### 6.2 異常處理

- 若單檔股票資料不通過驗證：
  - 該股票當日資料標記為失敗，不寫入正式表。
  - 記錄錯誤原因（欄位缺失、數值不合理等）。
- 若整體來源級錯誤（例如來源 API 無法連線）：
  - 任務標記為失敗，並觸發告警機制（v1 可先記錄 log，未來可接入 alert 系統）。
- 若部分股票失敗但其他成功：
  - 整體任務視為「部分成功」。
  - 後續可依失敗清單觸發 recovery。

---

## 7. 儲存與對內介面

### 7.1 儲存邏輯需求

- 必須能依以下維度快速查詢：
  - 單檔股票在指定日期區間的日 K 序列。
  - 多檔股票在同一日期的日 K 資料。
- 支援依條件篩選：
  - 市場別（上市/上櫃）
  - 產業別
  - 股票狀態（正常/下市等）
- 必須具備基礎索引設計概念（例如以「股票代碼 + 日期」作為主鍵）。

> 註：本文件不指定具體資料庫種類與表結構名稱，由工程實作時決定。

### 7.2 對內資料介面需求

分析模組應能透過統一介面取得資料，介面應支援：

- 依「股票代碼 + 日期區間」取得日 K 序列。
- 依「日期 + 市場別」取得該日所有股票日 K。
- 取得股票基本資料：
  - 依股票代碼查詢單檔資訊。
  - 依市場別/產業別列出股票清單。

此介面僅描述「行為」，不指定技術形式（函式、API、RPC 等）。

---

## 8. 排程與資源限制

### 8.1 排程總覽（台北時間）

- 每日例行抓取：
  - 每交易日 18:15 啟動
  - 失敗時自動於 18:30 與 18:45 重試
- 回補任務：
  - 若有待執行的回補任務，建議於每日 02:00 啟動
  - 執行期間如接近例行抓取時間，須避免資源互相影響（可考慮避免重疊或限制併發）

### 8.2 資源與限流需求

- 對外部資料來源須有基本限流控制（例如每秒最大請求數）。
- 對內部儲存層需避免一次大量批次寫入導致壓力過大：
  - 可透過批次分塊處理（例如每批固定數量股票或固定日期段）。

---

## 9. 監控與紀錄

### 9.1 執行層級紀錄

每次任務執行需至少紀錄：

- 任務類型（每日例行 / 回補 / 重抓）
- 任務參數（日期區間、股票清單、市場別等）
- 開始時間、結束時間
- 成功/失敗狀態
- 成功處理筆數、失敗檔數
- 若失敗，需提供失敗原因摘要

### 9.2 股票層級紀錄

對於個別股票失敗，需紀錄：

- 股票代碼
- 日期/日期區間
- 失敗階段（取得/解析/驗證/寫入）
- 具體錯誤資訊（可簡化）

---

## 10. 非功能性需求

### 10.1 效能

- 每日例行抓取：
  - 在正常網路與來源狀態下，建議在 30 分鐘內完成「當日所有上市/上櫃股票日 K 抓取與寫入」。
- 回補任務：
  - 允許耗時較長，但需有進度可觀察（例如分批紀錄）。

### 10.2 可靠性

- 任務失敗不可默默消失，必須有紀錄可查。
- 設計上需預留未來接入通知/告警系統的空間。

### 10.3 可擴充性

- 未來擴充內容範例：
  - 新增更多資料類型（例如月營收、財報、法人買賣超等）。
  - 新增更多市場或商品種類（例如期貨、選擇權）。
- 現在的架構不應因新增一種資料，就需要大幅改動既有流程。

---

## 11. 開發與測試重點

### 11.1 開發重點（給工程師與 Codex 的方向）

- 優先完成：
  1. 日 K 資料取得與儲存
  2. 每日例行抓取流程
  3. 資料驗證與錯誤紀錄
- 回補與重抓功能可在日 K 基本流程穩定後再補上。

### 11.2 測試建議

- 單元測試：
  - 資料解析與驗證規則
  - 錯誤情境模擬（欄位缺失、數值異常等）
- 整合測試：
  - 模擬「每日例行抓取」流程，驗證整體資料流是否正確。
  - 回補與重抓情境下，資料是否正確覆蓋或補齊。

---

## 12. 未來擴充方向（非 v1 必要）

- 支援更細時間粒度（例如 5 分鐘 K、1 分鐘 K）。
- 整合交易日曆服務，精確處理所有休市/半日市、補班日等。
- 對接通知與告警系統：
  - 當連續多日失敗或異常比例過高時通知運維。
- 提供對外 API 讓其他系統可查詢原始資料。
