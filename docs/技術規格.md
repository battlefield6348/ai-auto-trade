# 技術規格文件 (Technical Specifications)

本文件定義系統的資料結構、API 設計及技術實作細節。

---

## 1. 資料庫模型 (Database Schema)

### 1.1 核心分析資料
*   **stocks**：儲存交易對基本資料（如 `trading_pair: BTCUSDT`）。
*   **analysis_results**：儲存每日計算後的技術指標與 AI 原始分數。
    *   `score`: AI 原始評分 (0-100)。
    *   `close_price`, `change`, `volume_ratio` 等。

### 1.2 策略與規則
*   **strategies**：儲存策略元資料、進場/出場閾值。
*   **strategy_rules**：連結策略與具體條件，存儲每個條件的權重與規則類型 (entry/exit)。
*   **conditions**：定義具體的判斷邏輯類型（如 `BASE_SCORE`, `PRICE_RETURN`, `VOLUME_SURGE`）及其參數。

### 1.3 交易紀錄
*   **strategy_trades**：儲存所有買賣紀錄（含進場價、出場價、損益、環境）。
*   **strategy_positions**：儲存目前未平倉的部位。

---

## 2. API 介面規格

### 2.1 回測 API (`/api/analysis/backtest`)
*   **Method**: `POST`
*   **用途**：執行即時回測計算。
*   **Input**: 交易對、日期區間、各項權重比例、門檻值。
*   **Output**: 
    *   `events`: 觸發條件的事件列表。
    *   `trades`: 模擬交易明細（含進出場日期、價格、盈虧）。
    *   `summary`: 績效摘要（總交易數、總收益率、勝率）。
    *   `stats`: 基於特定天數的預期收益統計。

### 2.2 策略管理 API (`/api/admin/strategies`)
*   **GET**：列出資料庫中所有已存儲策略。
*   **POST**：將當前 UI 配置儲存為新策略。
*   **GET `/:id/activate`**：啟動該策略的自動監聽。
*   **GET `/:id/deactivate`**：停止監聽。

### 2.3 交易資訊 API (`/api/admin/trades`)
*   **GET**：根據環境 (test/paper/real) 撈取歷史交易資料。
*   **GET `/positions`**：查詢當前持倉。

---

## 3. 系統核心邏輯細節

### 3.1 評分計算 (Server-side)
評分邏輯實作於後端，確保回測與真實交易的一致性：
*   `calcBacktestScore` (Ad-hoc 回測)
*   `ScoringStrategy.CalculateScore` (正式策略執行)

### 3.2 下單價格採樣
*   **預設採樣**：所有交易訊號於 T 日收盤後產生，買入/賣出動作默認於 **T+1 日開盤** 執行。
*   **費用計算**：預設扣除 0.1% 的滑價與手續費模型。

---

## 4. 驗證與安全

*   **JWT 認證**：所有帶有 `/api/admin` 前綴的請求皆需在 Header 帶入 `Authorization: Bearer <token>`。
*   **DSN 配置**：數據庫連接與 Binance API Key 透過 `config.yaml` 或環境變數安全讀取。
