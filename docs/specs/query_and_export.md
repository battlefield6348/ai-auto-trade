# 分析結果查詢與輸出介面（Query & Export Interface）功能規格

版本：v1.0  
狀態：草稿  
最後更新：2025-12-02

---

## 1. 功能簡介

本文件定義「分析結果查詢與輸出介面（Query & Export Interface）」之產品需求與行為規格，作為後端系統實作與測試依據。

本功能目標：  
在「日批次分析核心」已產生分析結果的前提下，提供統一的查詢與輸出能力，讓：

- 前端 UI
- 報表服務
- 其他內部系統（策略／風控／通知）

能方便地依各種條件讀取、篩選、排序分析結果，並支援批次匯出。

---

## 2. 範圍與非範圍

### 2.1 功能範圍（In Scope）

- 針對「分析結果」提供統一的查詢行為：
  - 依日期為主（例如：查詢某日全市場的分析結果）
  - 依股票為主（例如：查單一股票的歷史分析結果）
  - 依條件篩選（市場、產業、分數區間、標籤等）
- 排序與分頁能力（避免一次返回過大資料集）
- 基本匯出機制：
  - 支援匯出為檔案（如 CSV）或等價的批次資料流（依實作決定）
- 權限與使用限制的需求描述（邏輯層面）
- 介面版本化與向下相容需求（行為層面）

### 2.2 非功能範圍（Out of Scope，在 v1 不處理）

- 對外公開 API 的金流／授權／限速策略
- 視覺化圖表（K 線圖、走勢圖等）本身的實作
- 前端 UI 設計（本文件僅定義後端介面行為）
- 複雜報表排版系統（如 PDF 報表樣板）

---

## 3. 前置條件與依賴

### 3.1 依賴功能

本功能依賴：

- 「台灣股票資料取得（Data Ingestion）」  
- 「日批次分析核心（Daily Batch Analysis Core）」

分析結果需已落地於儲存層，且結構化欄位可供查詢。

### 3.2 資料可用性假設

- 分析結果中，至少具備以下邏輯欄位：
  - 股票代碼
  - 交易日期
  - 市場別
  - 產業別
  - 價格與報酬欄位（當日收盤價、漲跌幅、近 N 日報酬等）
  - 成交量與量能變化欄位
  - 趨勢／均線相關欄位
  - 標籤（tags）
  - 綜合分數（score）
- 儲存層已依「股票代碼 + 日期」有基本索引能力（詳見前一份分析核心規格）。

---

## 4. 使用情境與角色

### 4.1 角色定義

- 前端應用程式（內部使用）
  - 顯示排行榜、股票清單、個股分析細節頁
- 報表／批次服務
  - 依固定條件定期匯出分析結果（例如每日 Top N 強勢股）
- 內部工程師／運維
  - 驗證分析結果是否合理
  - 支援除錯與人工查詢

### 4.2 主要使用情境

1. 使用者在前端選擇日期、產業別與排序方式，取得「當日強勢股排行榜」。
2. 系統每日產生一份「量能放大股票清單」檔案，用於後續策略或通知。
3. 研究人員查詢單一股票在過去 120 個交易日的分析結果，用於畫圖或做回顧分析。
4. 工程師在除錯時，查詢特定股票在某日的「分析輸入 + 分析輸出」摘要。

---

## 5. 查詢功能需求

本節不約束具體技術形態（REST、gRPC 等），僅描述行為與參數。

### 5.1 依日期查詢列表（當日市場視圖）

#### 5.1.1 目的

支援「某一交易日」為主的列表查詢，用於：

- 排行榜
- 條件篩選
- 分頁瀏覽

#### 5.1.2 查詢條件（範例需求）

必要條件：

- 交易日期（必填）

可選過濾條件：

- 市場別（上市、上櫃、全部）
- 產業別（可多選）
- 股票代碼列表（可多選，空則為不限制）
- 分數區間（例如 0–100）
- 近 N 日報酬區間（例如 近 5 日、近 20 日）
- 成交量或成交量放大倍率門檻
- 指定標籤（tags）條件：
  - 包含任一標籤
  - 必須同時包含多個標籤

排序選項（至少）：

- 綜合分數（由高到低）
- 近 5 日報酬
- 近 20 日報酬
- 成交量放大倍率
- 當日漲跌幅

分頁需求：

- 支援 page / page_size 或 offset / limit 模式
- 預設每頁筆數上限（例如 100 筆，具體數字由實作決定）

### 5.2 依股票查詢歷史分析結果（個股視圖）

#### 5.2.1 目的

支援「單一股票」為主的時間序列查詢，用於：

- 個股歷史走勢分析
- 繪製分數、報酬、量能等時間序列圖

#### 5.2.2 查詢條件

必要條件：

- 股票代碼（必填）

可選條件：

- 日期區間（起始日期、結束日期）
  - 若未指定，可預設回傳最近 N 個交易日（例如 60 日）
- 是否排除分析失敗紀錄（預設排除）

排序：

- 固定以日期由舊到新排序，便於繪圖與時序分析。

### 5.3 單筆分析結果查詢（詳細視圖）

#### 5.3.1 目的

用於前端「個股當日明細頁」，或工程師除錯查看當日分析細節。

#### 5.3.2 查詢條件

- 股票代碼
- 交易日期

返回內容需包含：

- 該日分析結果所有欄位（價格、報酬、指標、分數、標籤、狀態等）
- 最低限度的 meta 資訊：
  - 分析版本
  - 執行時間
  - 若失敗則提供失敗原因文字

---

## 6. 匯出功能需求（Export）

### 6.1 匯出目標

提供「批次匯出」能力，支援：

- 每日產出固定條件的清單檔案（例如：當日 Top 200 強勢股）
- 臨時由前端或後台工具觸發匯出某段時間／某一組條件的結果

### 6.2 匯出內容要求

常見匯出情境與必備欄位（示意）：

1. 當日強勢股清單
   - 日期
   - 股票代碼
   - 股票名稱
   - 市場別
   - 產業別
   - 收盤價
   - 當日漲跌幅
   - 近 5 日報酬
   - 近 20 日報酬
   - 成交量 / 成交量放大倍率
   - 綜合分數
   - 主要標籤列表（可用分隔符）

2. 量能放大股清單
   - 日期
   - 股票代碼
   - 股票名稱
   - 成交量
   - 近 5 日／20 日均量
   - 放大倍率
   - 簡要標籤（如：短期強勢／接近前高等）

3. 個股歷史分析匯出
   - 股票代碼
   - 每日日期
   - 主要指標（收盤價、報酬、MA、分數等）

> 實際哪些匯出模板要先做，可由產品方後續優先順序決定。v1 最少需支援「當日強勢股清單」的固定匯出。

### 6.3 匯出觸發方式

- 定期匯出：
  - 可由排程於每日分析任務完成後自動觸發。
- 手動匯出：
  - 由後台工具或 API 觸發，需帶入查詢條件與匯出範圍。

### 6.4 匯出結果交付方式

本文件不限制具體交付方式，但須滿足：

- 能以檔案形式保存與下載（如 CSV 或等價格式）
- 每次匯出需有唯一識別（例如匯出 ID），便於追蹤
- 匯出完成與失敗須有紀錄（含條件、筆數、時間）

---

## 7. 權限與使用限制（邏輯）

### 7.1 權限層級（邏輯）

- 內部系統／服務：
  - 可使用所有查詢與匯出能力。
- 未來若對外開放：
  - 本功能需預留區分：
    - 允許查詢的欄位範圍
    - 單次最大筆數限制
    - 單位時間內請求頻率限制

> v1 僅需在介面層保留設計彈性，不必實作完整權限系統。

### 7.2 查詢與匯出限制

- 查詢單次最大筆數限制（例如 1000 筆）以防止意外拉出全部市場長期資料。
- 匯出需使用「明確的條件與日期範圍」，禁止無限制全庫匯出。
- 必須有錯誤回報：
  - 當使用者請求超過限制時，需明確提示是「條件過大」而非一般錯誤。

---

## 8. 介面版本管理

### 8.1 版本欄位需求

- 每筆分析結果本身已有「分析版本」欄位。
- 查詢介面層需能：
  - 指出目前使用的介面版本（例如 v1）
  - 若未來介面改版，需能共存一段時間（舊版查詢不立刻失效）

### 8.2 相容性要求

- 新增欄位不得破壞現有查詢行為（例如 JSON 新增欄位應避免影響既有 client）。
- 已存在欄位若需重新定義含義，需透過新版本介面實現，不得直接改寫舊行為。

---

## 9. 非功能性需求

### 9.1 效能

- 典型查詢（例如：單日 Top 200 強勢股）應在合理時間內回應（例如數百毫秒等級，實際 SLA 由實作補充）。
- 大量分頁瀏覽（如前端用戶連續翻頁）需有適當索引支援。

### 9.2 可用性

- 查詢介面應設計為即使「批次分析任務當天失敗」，仍能查詢過去日期的歷史分析結果。
- 若查詢日期尚未有分析結果，需返回明確狀態，而非回傳空資料混淆。

### 9.3 可觀測性

- 每一類查詢需有基本紀錄：
  - 查詢類型
  - 條件摘要（避免記錄過多細節）
  - 返回筆數
  - 執行時間
- 可出具統計：
  - 最常用的查詢條件模式
  - 平均查詢耗時

---

## 10. 開發與測試重點

### 10.1 開發優先順序

建議 v1 先實作：

1. 依日期查詢列表（含排序、過濾、分頁）
2. 單一股票歷史查詢
3. 單筆分析結果詳細查詢
4. 至少一個固定匯出模板（例如：當日強勢股清單）

之後再擴充：

- 更多條件組合
- 更多匯出模板
- 對外授權與限流機制

### 10.2 測試建議

- 單元測試：
  - 查詢條件組合的解析與轉換
  - 各種排序、分頁邏輯
- 整合測試：
  - 搭配真實／模擬資料庫，驗證查詢效能與正確性
- 邊界情境：
  - 無資料情境（日期無分析結果）
  - 超出最大筆數限制
  - 極端查詢條件（如非常小或非常大的範圍）

---

## 11. 未來擴充方向（非 v1 必要）

- 提供「即時查詢 + 歷史快照」混合視圖（例如同時顯示當日分析與盤中價格）。
- 引入「自訂欄位組合查詢」，讓使用者自訂想要顯示的欄位。
- 整合通知系統，依查詢結果自動觸發訊息（如符合特定標籤即通知）。

