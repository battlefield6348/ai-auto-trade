# 技術規格文件 (Technical Specifications)

本文件定義系統的資料結構、API 設計及技術實作細節。

---

## 1. 資料庫模型 (Database Schema)

### 1.1 核心分析資料
*   **stocks**：儲存交易對基本資料（如 `trading_pair: BTCUSDT`）。
*   **analysis_results**：儲存計算後的技術指標與 AI 原始分數。
    *   `timeframe`: 資料對應的時間週期（如 `1m`, `1h`, `1d`）。
    *   `trade_date`: 該 K 線的起始時間。
    *   `score`: AI 原始評分 (0-100)。
    *   `close_price`, `change`, `volume_ratio` 等。

### 1.2 策略與規則
*   **strategies**：儲存策略元資料、進場/出場閾值及 `timeframe` 設定。
*   **strategy_rules**：連結策略與具體條件，存儲每個條件的權重與規則類型 (entry/exit)。
*   **conditions**：定義具體的判斷邏輯類型（如 `BASE_SCORE`, `PRICE_RETURN`, `VOLUME_SURGE`）及其參數。

### 1.3 交易紀錄
*   **strategy_trades**：儲存所有買賣紀錄（含進場價、出場價、損益、環境）。
*   **strategy_positions**：儲存目前未平倉的部位。

---

## 2. API 介面規格

### 2.1 回測 API (`/api/analysis/backtest`)
*   **Method**: `POST`
*   **用途**：執行即時回測計算。
*   **Input**: 交易對、日期區間、各項權重比例、門檻值。
*   **Output**: 
    *   `events`: 觸發條件的事件列表。
    *   `trades`: 模擬交易明細（含進出場日期、價格、盈虧）。
    *   `summary`: 績效摘要（總交易數、總收益率、勝率）。
    *   `stats`: 基於特定天數的預期收益統計。

### 2.2 策略管理 API (`/api/admin/strategies`)
*   **GET**：列出資料庫中所有已存儲策略。
*   **POST**：將當前 UI 配置儲存為新策略。
*   **GET `/:id/activate`**：啟動該策略的自動監聽。
*   **GET `/:id/deactivate`**：停止監聽。

### 2.3 交易資訊 API (`/api/admin/trades`)
*   **GET**：根據環境 (test/paper/real) 撈取歷史交易資料。
*   **GET `/positions`**：查詢當前持倉。

---

## 3. 系統核心邏輯細節

### 3.1 評分計算 (Server-side)
評分邏輯實作於後端，確保回測與真實交易的一致性：
*   **多向過濾**：`calcBacktestScore(..., targetSide)` 會根據傳入的 `targetSide` ("entry" 或 "exit")，自動篩選權重配置中匹配該方向（或為 `both`）的規則進行匯總。
*   **回測執行**：回測引擎會在每一天同時計算 `EntryScore` 與 `ExitScore`。
*   **核心組件**：
    *   `ScoringStrategy.CalculateScoreForRules`：執行特定規則集合的加權加總。
    *   `IsExitTriggered`：判斷特定方向分數是否「低於」出場閾值。

### 3.3 多時間週期傳遞與執行
*   **API 支援**：所有涉及價格與分析的 API 均需帶入 `timeframe` 參數。
*   **延遲計算**：系統會根據 K 線的完結時間（Close Time）來決定信號的有效性。
*   **資料隔離**：不同時間週期的分析結果於資料庫中透過 `(symbol, timeframe, trade_date)` 唯一鍵進行隔離，避免數據混淆。

### 3.4 下單價格採樣與成本
*   **時間點**：所有交易訊號於 T 日收盤後產生，買入/賣出動作直接採計當日收盤價。
*   **費用計算**：平倉時會自動套用 **0.999** 的乘數（扣除 0.1% 成本），計算出的 PnL 包含此摩擦成本。

---

## 4. 驗證與安全

*   **JWT 認證**：所有帶有 `/api/admin` 前綴的請求皆需在 Header 帶入 `Authorization: Bearer <token>`。
*   **DSN 配置**：數據庫連接與 Binance API Key 透過 `config.yaml` 或環境變數安全讀取。
