# 通知與警報系統（Alert & Notification Engine）功能規格

版本：v1.0  
狀態：草稿  
最後更新：2025-12-02

---

## 1. 功能簡介

本文件定義「通知與警報系統（Alert & Notification Engine）」之產品需求與行為規格。

目的：

- 讓使用者能訂閱某些條件（如選股條件、標籤變化、分數突破等）
- 當條件被觸發時，自動通知使用者或內部系統
- 亦可用於監控系統異常（如資料取得失敗、分析失敗比例過高）

通知系統為整個平台重要的上層功能，讓系統從「查詢型」升級到「推送型」。

---

## 2. 範圍與非範圍

### 2.1 功能範圍（In Scope）

- 使用者或系統可「訂閱」一種條件
- 系統每日根據分析結果執行訂閱條件
- 若條件成立，則觸發通知
- 支援通知管道（行為層級）：
  - Email
  - Webhook（供內部系統使用）
  - App internal message（未來）
- 支援兩類通知：
  1. **選股型警報**（基於 Screener 結果）
  2. **系統健康警報**（資料抓取、分析任務異常）

### 2.2 非範圍（Out of Scope）

- 即時盤中警報（v1 僅支援日階層）
- 完整後台 UI 設計
- 完整使用者帳號管理

---

## 3. 前置條件與依賴

本功能依賴：

- 選股器（Stock Screener）
- 日批次分析核心（Daily Batch Analysis Core）
- 分析結果查詢與輸出介面（Query & Export）

訂閱條件需能透過選股器表示。

---

## 4. 使用情境與角色

### 4.1 選股型使用情境

1. 使用者訂閱「量能放大 + 短期強勢」的條件
2. 每日分析完成後（約 19:30–20:00），系統套用該條件
3. 若符合條件股票清單非空，則推送通知給使用者

範例推播內容（邏輯層級）：

- 2025/12/02「量能放大 + 短期強勢」  
- 共 13 檔股票符合條件  
- 代表個股摘要（例如最多顯示前 3 檔）

### 4.2 系統健康警報情境

1. 每日資料抓取任務（Data Ingestion）失敗超過某比例
2. 分析結果少於平常應有數量（例如少了 100 檔以上）
3. 選股器返回異常空集合（但不應該空）
4. 匯出任務連續兩天失敗

系統需自動發送警告給內部工程師或 DevOps。

---

## 5. 訂閱條件模型（Subscription Model）

訂閱條件需具備可儲存、可重複運行特性。

### 5.1 訂閱類型

#### 類型 A：選股條件訂閱（Screener-Based Subscription）

- 基於選股器的條件結構（Condition Model）
- 支援：
  - 日期由系統自動決定（每日最新分析）
  - AND/OR 單層邏輯
  - 排序方式（僅告知結果，不需要排序）

使用範例：

- 量能放大倍率 > 2 AND 近 5 日報酬 > 3%
- 標籤包含「短期強勢」AND 排除「高波動」

#### 類型 B：單股票監控（Stock Watch Subscription）

- 使用者可訂閱某一股票的「條件觸發」
- 例如：
  - 2330 近 5 日報酬 > 5%
  - 2330 的分數突破 80 分
  - 2330 今日出現「接近前高」標籤

#### 類型 C：系統異常訂閱（Internal System Alerts）

- 由內部運維使用
- 例：
  - 今日 Data Ingestion 失敗率 > 5%
  - 分析任務失敗比例 > 2%
  - 匯出任務連續兩天失敗

---

## 6. 通知觸發規則

### 6.1 每日觸發時機

流程：

1. Data Ingestion → 成功後
2. Daily Batch Analysis → 成功後
3. Screener / Subscriptions Engine → 套用所有「選股型訂閱」
4. Notification Engine → 發送通知

建議在每日 **20:00–20:15** 間執行。

### 6.2 條件成立邏輯

- 若選股結果集合 **非空** → 通知  
- 若股票監控的條件成立 → 通知  
- 若系統健康檢查有異常 → 通知  

### 6.3 去重與節流

為避免多次重複通知：

- 同一訂閱在同一天只會觸發一次
- 對於相同接收者、相同訂閱類型，在短時間內避免反覆通知（例如至少間隔 5 分鐘）

---

## 7. 通知內容規格

### 7.1 基本通知格式

每則通知需包含：

- 訂閱 ID
- 訂閱名稱（例如「量能放大 + 強勢」）
- 通知日期
- 通知類型（選股型 / 股票監控 / 系統警告）

### 7.2 選股型通知內容

包括：

- 觸發日期（如 2025-12-02）
- 命中股票總數
- 若股票過多（如 > 20），則僅顯示前幾檔（例如前 5–10 檔）
- 每檔需顯示：
  - 股票代碼
  - 股票名稱
  - 收盤價
  - 分數
  - 主要標籤列表

如需精簡，可提供：

- 統計摘要（例如「平均分數 78」、「多為半導體族群」等）
  - v1 可不做，自動摘要可留給 v2

### 7.3 股票監控通知內容

若監控單一股票，需包含：

- 股票代碼＋名稱
- 為何命中（例如「分數由 75 → 82」）
- 啟動此條件的值

### 7.4 系統警報通知內容

需包含：

- 異常類型（如：資料抓取失敗過多）
- 異常數據（例如失敗率 12%）
- 影響範圍（例如缺少 58 檔股票資料）
- 建議動作（可簡單描述，如「請檢查資料來源狀態」）

---

## 8. 通知管道（Channels）

### 8.1 Email

- 支援純文字通知
- 支援附檔（如 CSV）  
  - v1 可不強制附檔，僅推播摘要即可

### 8.2 Webhook

- 觸發內部系統（如策略引擎）
- Payload 包含通知內容完整結構化資料

### 8.3 App internal message（保留）

- 若未來有前端環境，則可直接顯示通知卡片

---

## 9. 訂閱管理（Subscription Management）

### 9.1 建立訂閱

使用者需能：

- 選擇通知名稱
- 選擇通知類型
- 輸入選股器條件（或使用模板）
- 選擇通知管道
- 設定通知的「最低門檻」（例如至少 3 檔股票命中才通知）

### 9.2 編輯訂閱

使用者需能修改：

- 條件
- 通知管道
- 門檻
- 排序規則（若適用）

### 9.3 停用／刪除訂閱

需能標記訂閱為停用，不再執行。

---

## 10. 排程與任務流程

每日通知流程：

1. 讀取所有啟用中的訂閱
2. 分類（選股型／股票型／系統型）
3. 各分類依照規則執行：
   - 選股型 → 套用 Screener
   - 股票型 → 取單股分析結果
   - 系統型 → 執行健康檢查邏輯
4. 判斷條件是否成立
5. 生成通知內容
6. 寄送／推播
7. 寫入通知歷史紀錄

---

## 11. 儲存與查詢需求

### 11.1 儲存需求

需儲存：

1. 訂閱清單（訂閱 ID、名稱、條件、管道、狀態）
2. 通知歷史（含通知內容）
3. 系統健康監控基礎數據（每日一筆）

### 11.2 查詢功能

- 查詢某使用者所有訂閱
- 查詢某日期的通知紀錄
- 查詢特定訂閱的觸發歷史

---

## 12. 非功能性需求

### 12.1 穩定性

- 任務不可因單一訂閱失敗拖垮整個通知流程
- 若 Webhook endpoint 回應失敗，可採線性重試（例如重試 3 次）

### 12.2 效能

- 系統需能處理至少數百個訂閱（v1）  
  未來可水平擴充到數千甚至上萬。

### 12.3 可觀測性

紀錄：

- 通知執行耗時
- 每日成功率與錯誤比率
- 最常用的訂閱條件

---

## 13. 開發與測試重點

### 13.1 開發重點

1. 訂閱模型（Subscription Model）
2. 套用選股器的邏輯
3. 通知路由（Email / Webhook）
4. 通知紀錄
5. 系統健康監控邏輯

### 13.2 測試建議

- 條件命中測試
- 大量訂閱效能測試
- Webhook 重試流程
- 錯誤隔離（單一訂閱錯誤不影響整體）

---

## 14. 未來擴充（非 v1）

- 支援盤中即時通知
- 利用機器學習自動推薦訂閱條件
- 支援「回測訂閱」，檢查過去 n 年是否會觸發
- 支援群組通知或群組訂閱模板

