# 功能規格文件 (Functional Specifications)

本文件定義本系統的所有核心功能、業務邏輯與使用者操作流程。本文件代表系統目前的最終狀態，不包含未來規劃。

---

## 1. 資料擷取與分析 (Data Ingestion & Analysis)

### 1.1 市場資料擷取
*   **目標交易對**：目前主要支援 `BTCUSDT`（可擴充其他交易對）。
*   **資料來源**：Binance API (日 K 線)。
*   **排程更新**：配合每日交易時間，自動抓取最新的收盤數據。
*   **手動補償**：支援從特定日期開始回補歷史數據。

### 1.2 日批次分析
*   **基礎指標計算**：
    *   移動平均線 (MA5, MA10, MA20, MA60)。
    *   價格乖離率 (Deviation)。
    *   成交量放大倍率 (Volume Ratio)。
    *   漲跌幅 (Change Rate)。
    *   區間高低點 (20日高點/低點)。
*   **AI 評分系統**：
    *   根據多維度指標計算出一個 0-100 的基礎分數 (`BASE_SCORE`)。
    *   分數代表該交易對在當前技術面下的強度。

---

## 2. 交易策略與評分系統 (Scoring Strategy)

### 2.1 權重評分邏輯
系統採用「加權評分制」來決定進場與出場。總分計算公式為：
`總分 = (AI 基礎分 * 權重) + 漲跌加分 + 量能加分 + 報酬加分 + 乖離加分`

*   **BASE ANALYSIS SCORE**：作為核心乘數 (0-1.0 倍)。
*   **加分項 (Bonuses)**：當符合特定門檻（例如日漲幅 > 0.5%）時，額外增加固定分數。

### 2.2 進出場決定
*   **進場閾值 (Entry Threshold)**：當總分超過設定門檻（例如 80 分）時發出買入訊號。
*   **出場閾值 (Exit Threshold)**：當總分低於設定門檻（例如 10 分）或符合特定條件時發出賣出訊號。

---

## 3. 回測與模擬控制台 (Backtest Console)

### 3.1 歷史回測
*   **自訂參數**：使用者可動態調整權重、門檻及日期區間。
*   **連續模擬 (Sequential Simulation)**：調整參數後，系統會執行模擬交易流。當分數達到進場門檻時「買入持倉」，並在達成賣出條件或分數轉弱時「平倉結算」。
*   **績效統計 (Performance Summary)**：
    *   **交易次數**：統計回測區間內實際完成的總筆數。
    *   **累積收益率**：計算複利或累加後的最終百分比收益。
    *   **勝率**：獲利交易筆數佔總交易筆數的比例。
*   **詳細交易日誌 (Trade Logs)**：
    *   展示每筆交易的 **進場日期/價格** 與 **出場日期/價格**。
    *   標註單次交易的盈虧 (PnL %) 與出場原因。
*   **數據可視化**：
    *   **趨勢圖**：展示回測區間內的分數與收盤價曲線。
    *   **未來收益分析**：統計命中後的固定天數 (3d, 5d, 10d) 的平均預期收益。

### 3.2 策略聯動與管理
*   **整合操控台**：回測按鈕統一整合。當切換為「手動模式」時可任意調整條件；當選取既存策略時，系統自動載入該策略的權重與門檻。
*   **即時參數微調**：載入策略後，使用者仍能在畫面上直接微調參數並立即執行新的回測，無需先儲存覆蓋。
*   **儲存為策略**：使用者可將目前調整好的最佳參數儲存至資料庫。
*   **策略部署**：可從回測結果直接將該參數組設為「現役策略」，供實盤/模擬盤監控使用。

---

## 4. 自動交易監控 (Real-time Trading)

### 4.1 執行環境 (Environments)
系統支援三種執行環境：
1.  **Test (測試網)**：對接 Binance Testnet API，使用虛擬美金執行真實交易流程。
2.  **Paper (模擬盤)**：根據主網真實行情進行虛擬記錄，不發送真實訂單。
3.  **Live (正式盤)**：對接 Binance 正式 API 執行真實資金交易。

### 4.2 自動監控流程
*   **每日掃描**：系統會自動偵聽分析結果更新，一旦符合啟用中策略的門檻，即自動執行買入或賣出。
*   **狀態監控**：即時顯示目前持倉、各策略盈虧情形及最新交易日誌。
*   **手動介入**：支援在畫面上執行「一鍵平倉」或「手動下單」。

---

## 5. 身分驗證與權限 (Auth & RBAC)

*   **登入系統**：使用 Email 與密碼進行身分驗證，並透過 JWT (JSON Web Token) 管理 Session。
*   **角色劃分**：
    *   **Admin**：具備最高權限，可管理所有策略、使用者及系統配置。
    *   **User**：僅可檢視回測結果與個人基本設定。
*   **環境切換權限**：僅限管理員可切换 Live 環境，以避免誤操作。
