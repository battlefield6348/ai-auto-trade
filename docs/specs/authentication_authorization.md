# 登入與權限驗證（Authentication & Authorization）功能規格

版本：v1.0  
狀態：草稿  
最後更新：2025-12-03

---

## 1. 功能簡介

本文件定義「登入與權限驗證（Authentication & Authorization）」功能之產品需求與行為規格。

目標：

- 為整個「台灣股票分析服務」提供統一的身分驗證與權限管理機制。
- 確保只有授權使用者（或內部服務）能存取特定功能（資料抓取、分析、選股、策略、報表等）。
- 提供後續角色/權限擴充的基礎（Roles & Permissions）。

---

## 2. 範圍與非範圍

### 2.1 功能範圍（In Scope）

- 使用者帳號系統（User Account）
- 登入 / 登出流程（Login / Logout）
- 存取權杖（Access Token）與長效權杖（Refresh Token）機制
- 基本權限控制（依角色／權限決定可用功能）
- API 請求的身份驗證與授權檢查
- 簡單的帳號生命週期管理（啟用／停用）

### 2.2 非功能範圍（Out of Scope，在 v1 不處理）

- 第三方登入（Google / GitHub / Line 等）
- 完整自助註冊流程（一般使用者自行註冊）
- 完整密碼重設流程（忘記密碼 Email 流程）
- SSO / OAuth Provider / SAML 等企業級整合
- 前端 UI 的頁面設計（本文件僅定義後端行為）

---

## 3. 使用者角色與情境

### 3.1 使用者角色（User Types）

v1 至少區分：

1. **系統管理者（Admin）**
   - 管理使用者帳號、角色與權限。
   - 可檢視系統健康儀表板。
   - 可管理策略、訂閱、選股模板（包含建立/修改/停用）。

2. **內部分析人員（Analyst / Internal User）**
   - 可使用選股器。
   - 可建立個人策略與訂閱。
   - 可檢視分析結果、報表、產業與個股儀表板。
   - 不可變更其他使用者帳號與系統設定。

3. **一般使用者（End User）**
   - 可登入查看自己可見的功能範圍：
     - 選股器（在授權範圍內）
     - 自己的策略與訂閱
     - 基本市場/個股儀表板
   - 不可存取內部／系統級功能。

4. **系統服務帳號（Service Account）（可選，v1 可先預留）**
   - 給內部服務間呼叫使用，例如 CI / 批次程式。
   - 權限一般為機器對機器（machine-to-machine），不需要人類登入。

### 3.2 典型情境

- 分析人員登入 → 進入 UI → 使用選股器 → 建立策略與訂閱。
- Admin 登入 → 建立新使用者 → 指派角色 → 停用某帳號。
- 一般使用者登入 → 查詢「每日強勢股」報表、查看自己策略。
- 內部批次服務（Service Account）呼叫 API，觸發某些 internal 功能（例如回補、重跑分析），且必須通過權限驗證。

---

## 4. 帳號與登入流程

### 4.1 帳號建立（Account Creation）

v1 的帳號建立策略：

- **不提供公開註冊頁面**。
- 帳號僅能由 Admin 在內部後台 / 管理介面建立。
- 建立帳號時需設定：
  - Email（作為登入 ID）
  - 顯示名稱（Name）
  - 初始角色（Role）
  - 帳號狀態（啟用 / 停用）

初始密碼流程（兩種模式之一，可選）：

1. Admin 設定初始密碼並傳給使用者（v1 簡化，但安全性較弱）。
2. Admin 僅建立帳號並觸發「設定初始密碼」連結（未來與 Email 系統整合）。

本文件暫不規範 Email 發送細節，但需保留此能力。

### 4.2 登入（Login）

使用者透過：

- Email + 密碼 登入。

登入行為需求：

1. 驗證帳號是否存在且為啟用狀態。
2. 驗證密碼是否正確。
3. 若成功：
   - 回傳 Access Token（短效）與 Refresh Token（長效）。
   - Token 需包含：
     - 使用者 ID
     - 角色 / 權限資訊或其引用
     - Token 有效期限
4. 若失敗：
   - 清楚回應「帳號不存在／已停用／密碼錯誤」，在實作層可適度模糊以避免洩漏資訊。

### 4.3 登出（Logout）

- 若採「短效 Access Token + 長效 Refresh Token」模式：
  - 登出時需使 Refresh Token 失效（例如加入黑名單或更新 token 版本）。
  - Access Token 因為短效，可允許自然過期。

登出行為：

- 使用者主動呼叫登出 API。
- 系統更新後端記錄，防止 Refresh Token 再被使用刷新。

### 4.4 Token 概念（行為層級）

本文件不限制技術細節（JWT 或其他），但 v1 行為要求：

- **Access Token**
  - 有效時間短（例如 15–60 分鐘）。
  - 每個請求需攜帶，用於驗證身份與授權。
- **Refresh Token**
  - 有效時間長（例如 7–30 天）。
  - 僅用於取得新的 Access Token。
  - 若 Refresh Token 被撤銷或過期，使用者需重新登入。

Token 需具備：

- 可驗證是否由本系統簽發。
- 可辨識是否已失效或被撤銷。
- 可追蹤 Token 所屬使用者與當前角色。

---

## 5. 權限模型（Authorization Model）

### 5.1 採用「角色為主、權限為輔」模型

v1 要求：

- 系統至少有三個 Role：
  - `admin`
  - `analyst`
  - `user`
- 每個 Role 對應一組「可用功能權限」。

未來可擴充：

- 自訂 Role
- 更細粒度的 Permission（resource-level）

### 5.2 主要權限對應（邏輯）

以下為範例矩陣（邏輯層級，不是最終實作）：

| 功能                         | admin | analyst |   user   |
| ---------------------------- | :---: | :-----: | :------: |
| 登入系統                     |   ✔   |    ✔    |    ✔     |
| 管理使用者（建/改/停用）     |   ✔   |    ✘    |    ✘     |
| 查看系統健康儀表板           |   ✔   |   ✔?    |    ✘     |
| 使用選股器（Stock Screener） |   ✔   |    ✔    |    ✔     |
| 建立/修改策略（Strategy）    |   ✔   |    ✔    |    ✔     |
| 停用 / 刪除他人策略          |   ✔   |    ✘    |    ✘     |
| 建立/修改通知訂閱            |   ✔   |    ✔    |    ✔     |
| 存取內部 API（回補、重跑）   |   ✔   |   ✔?    |    ✘     |
| 查看完整產業/市場報表        |   ✔   |    ✔    | ✘/限制版 |

（`✔?` 表示可在 v1 先固定為 ✔ 或 ✘，由產品後續決定）

### 5.3 授權檢查（Authorization Check）

每個受保護的 API，在實作層需完成：

1. 驗證 Request 是否有合法 Access Token。
2. 從 Token 或後端查詢取得使用者角色。
3. 根據功能與角色，做「允許/拒絕」判斷。
4. 若拒絕，回應明確的錯誤狀態（如 HTTP 403 Forbidden）。

本文件不指定錯誤碼細節，但需維持行為一致。

---

## 6. API 存取規則（行為）

### 6.1 公開資源（Public）

以下資源在 v1 可選擇「不需登入」：

- 健康檢查（Health Check）端點
- 版本資訊（Version Info）

所有其他業務 API 預設為「需要登入」。

### 6.2 需登入資源（Protected）

- 查詢分析結果
- 使用選股器條件查詢
- 建立/修改策略與訂閱
- 查看個股/產業/策略儀表板
- 管理使用者（僅 admin）

所有 Protected API 行為：

- 沒有 token → 401 Unauthorized
- 有 token 但權限不足 → 403 Forbidden

---

## 7. 安全性需求（Security Requirements）

### 7.1 密碼安全

- 密碼需以安全方式保存（不可明文）。
- 密碼最小複雜度要求（行為層級）：
  - 至少 N 個字元（例如 8）
  - 建議包含字母與數字（具體要求由實作決定）

### 7.2 暴力破解防護

v1 至少行為需求：

- 連續登入失敗超過一定次數（例如 5 次），可暫時鎖定帳號或需冷卻時間。
- 實作層可採：
  - 帳號層鎖定
  - IP / User-Agent 層限制

### 7.3 Token 安全

- Refresh Token 洩漏風險需被考量：
  - 可在 DB 中維護 token 版本或黑名單。
- 若 Admin 偵測帳號疑似被盜，可：
  - 強制登出（讓所有 token 失效）
  - 停用帳號

---

## 8. 帳號狀態管理

使用者帳號需至少有以下狀態：

- `active`：可登入與使用。
- `disabled`：不可登入，所有 token 應視為無效。
- （可選）`locked`：因多次登入失敗暫時鎖定。

Admin 需具備以下操作能力：

- 啟用 / 停用帳號。
- 變更使用者角色。
- 重設密碼（或觸發「重設密碼流程」）。

---

## 9. 日誌與稽核（Audit & Logging）

系統需紀錄以下事件：

- 登入成功與失敗（含使用者 ID、IP、時間）。
- 登出事件。
- 密碼變更事件。
- 角色變更、帳號停用／啟用操作（需記錄操作者 ID）。
- 權限拒絕事件（嘗試存取無權限資源）。

目的：

- 事後稽核／除錯。
- 監控可疑行為（暴力破解、非法存取）。

---

## 10. 非功能性需求

### 10.1 可用性

- 登入相關 API 在正常情況下應具備高可用性。
- 即使部分業務服務有問題，只要驗證服務正常，仍可登入系統。

### 10.2 擴充性

- 未來可以：
  - 加入第三方登入（OAuth/OIDC）。
  - 導入多因素驗證（MFA）。
  - 導入更細緻的權限（Resource-based ACL）。

### 10.3 效能

- 登入與 token 驗證需在低延遲內完成（例如 <200ms，實際 SLA 由實作補充）。
- token 驗證需適合高併發（建議偏向 stateless 設計，但本文件不強制）。

---

## 11. 與其他模組的關聯

- 所有 `/docs/specs/*` 中提到的「對內 API」，在實作層都必須透過本文件定義的 Authentication & Authorization 機制保護。
- Screener、Strategy、Alert、Reports 的 API 均為「需登入且需授權」。
- System Health Dashboard 與內部維運 API 僅限 `admin` 或 `analyst`（視最終權限規則而定）。

---

## 12. 開發與測試重點

### 12.1 開發重點

1. 使用者帳號模型（User Domain）
2. 登入 / 登出 / Refresh Token 流程
3. Token 產生與驗證機制
4. 角色與權限對應表
5. API 層的統一授權檢查 middleware / filter

### 12.2 測試建議

- 單元測試：
  - 密碼驗證、帳號狀態判斷。
  - Token 產生與驗證邏輯。
  - 角色 → 權限 mapping。

- 整合測試：
  - 實際呼叫保護 API，確認：
    - 未帶 token → 401
    - token 失效／錯誤 → 401
    - 角色不足 → 403
    - 權限足夠 → 200

- 邊界測試：
  - 大量錯誤登入嘗試。
  - Admin 強制停用帳號後，原本 token 的行為。

