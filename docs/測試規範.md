# 測試規範 (Testing Standards)

本文件定義 AI Auto Trade 專案的測試要求、策略與最佳實踐。

---

## 1. 測試目標 (Total Coverage > 80%)

為了確保核心交易邏輯與回測系統的穩定性，專案要求 **整體程式碼測試覆蓋率必須始終保持在 80% 以上**。

### 1.1 分層測試重點
*   **Domain 層 (100% 覆蓋目標)**: 包含 `evaluator.go`、`scoring_model.go` 等核心策略判斷邏輯。由於這是系統最關鍵的部分，所有分支（Happy path, Edge cases, Failure paths）都必須被測試。
*   **Application 層 (> 8Bit 覆蓋目標)**: 測試 Use Cases (如 `backtest_usecase.go`, `save_usecase.go`)。應使用 Mocking 技術隔離資料庫與外部 API。
*   **Infrastructure 層 (> 60% 覆蓋目標)**: 測試 Repository 與外部整合。使用 `sqlmock` 模擬資料庫操作，確保 SQL 查詢語法正確。

---

## 2. 測試策略

### 2.1 單元測試 (Unit Tests)
*   **命名慣例**: 檔案命名為 `*_test.go`，函式命名為 `TestXxx`。
*   **斷言工具**: 使用 Go 標準庫的 `testing` 函式。
*   **Mocking**:
    *   資料庫: 使用 `github.com/DATA-DOG/go-sqlmock`。
    *   介面 (Interfaces): 定義 Mock 結構實作介面（如 `mockDataProvider`）。

### 2.2 覆蓋率檢查指令
在根目錄執行：
```bash
go test -coverprofile=coverage.out ./...
go tool cover -func=coverage.out
```
查看詳細視覺化報告：
```bash
go tool cover -html=coverage.out
```

---

## 3. 測試撰寫指引

1.  **優先測試關鍵邏輯**: 涉及資金計算、條件觸發、權重計算的部分優先撰寫。
2.  **覆蓋錯誤路徑**: 不要只測試成功的案例，必須包含資料格式錯誤、資料庫連接失敗、參數不合法等路徑。
3.  **保持測試獨立性**: 每個測試案例應該相互獨立，不依賴前一個測試的執行狀態。
4.  **使用 Table-Driven Tests**: 對於多參數、多預期結果的邏輯（如 Evaluators），優先使用 Go 的 Table-driven 模式。

---

## 4. 持續集成 (CI)
(待補：未來應加入 GitHub Actions 在每次 PR 時自動執行測試並檢查覆蓋率門檻)
