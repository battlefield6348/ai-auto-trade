openapi: 3.0.3
info:
  title: AI Auto Trade MVP API
  version: "1.0.0"
  description: |
    MVP 端到端流程的 HTTP API。涵蓋登入、手動日 K 擷取、日批次分析、分析結果查詢與固定條件的強勢股篩選。
servers:
  - url: http://localhost:8080
    description: Local server
tags:
  - name: Health
  - name: Auth
  - name: Ingestion
  - name: Analysis
  - name: Screener
paths:
  /ping:
    get:
      tags: [Health]
      summary: 健康檢查
      responses:
        "200":
          description: pong
          content:
            text/plain:
              schema:
                type: string
                example: pong
  /api/auth/login:
    post:
      tags: [Auth]
      summary: 使用 Email/Password 登入並取得 Access Token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        "200":
          description: 登入成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        "401":
          description: 帳密錯誤或帳號未啟用
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/admin/ingestion/daily:
    post:
      tags: [Ingestion]
      summary: 手動觸發單日日 K 擷取
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TradeDateRequest'
      responses:
        "200":
          description: 執行成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IngestionResponse'
        "401":
          description: 未登入或 token 失效
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "403":
          description: 權限不足（需 admin 或 analyst，且具 ingestion.trigger_daily）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/admin/ingestion/backfill:
    post:
      tags: [Ingestion]
      summary: 回補指定日期區間的日 K 並可選擇同步分析
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BackfillRequest'
      responses:
        "200":
          description: 執行成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BackfillResponse'
        "400":
          description: 參數錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "401":
          description: 未登入或 token 失效
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "403":
          description: 權限不足（需 admin 或 analyst，且具 ingestion.trigger_backfill）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/admin/analysis/daily:
    post:
      tags: [Analysis]
      summary: 手動觸發單日分析
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TradeDateRequest'
      responses:
        "200":
          description: 執行成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnalysisJobResponse'
        "401":
          description: 未登入或 token 失效
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "403":
          description: 權限不足（需 admin 或 analyst，且具 analysis.trigger_daily）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "409":
          description: 缺少 ingestion 資料
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/analysis/daily:
    get:
      tags: [Analysis]
      summary: 依日期查詢分析結果
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: trade_date
          required: true
          schema:
            type: string
            format: date
          description: 交易日 (YYYY-MM-DD)
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
        - in: query
          name: offset
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        "200":
          description: 查詢成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnalysisQueryResponse'
        "400":
          description: 參數錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "401":
          description: 未登入或 token 失效
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "404":
          description: 指定日期尚無分析結果
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/analysis/history:
    get:
      tags: [Analysis]
      summary: 查詢指定交易對的歷史分析結果
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: symbol
          schema:
            type: string
            default: BTCUSDT
        - in: query
          name: start_date
          schema:
            type: string
            format: date
        - in: query
          name: end_date
          schema:
            type: string
            format: date
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 1000
        - in: query
          name: only_success
          schema:
            type: boolean
            default: true
      responses:
        "200":
          description: 查詢成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnalysisHistoryResponse'
        "400":
          description: 參數錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "401":
          description: 未登入或 token 失效
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/screener/strong-stocks:
    get:
      tags: [Screener]
      summary: 以固定條件回傳指定日期的強勢股清單
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: trade_date
          required: true
          schema:
            type: string
            format: date
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 50
        - in: query
          name: score_min
          schema:
            type: number
            format: float
            default: 70
        - in: query
          name: volume_ratio_min
          schema:
            type: number
            format: float
            default: 1.5
      responses:
        "200":
          description: 查詢成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScreenerResponse'
        "400":
          description: 參數錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "401":
          description: 未登入或 token 失效
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "404":
          description: 指定日期尚無分析結果
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    LoginRequest:
      type: object
      properties:
        email:
          type: string
          format: email
          example: user@example.com
        password:
          type: string
          format: password
          example: password123
      required: [email, password]
    LoginResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        access_token:
          type: string
          example: token-id-123
        token_type:
          type: string
          example: Bearer
        expires_in:
          type: integer
          description: 秒數
          example: 1800
    TradeDateRequest:
      type: object
      properties:
        trade_date:
          type: string
          format: date
          example: "2025-12-01"
      required: [trade_date]
    IngestionResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        trade_date:
          type: string
          format: date
        total_stocks:
          type: integer
          example: 1
        success_count:
          type: integer
          example: 2
        failure_count:
          type: integer
          example: 0
    BackfillRequest:
      type: object
      properties:
        start_date:
          type: string
          format: date
          example: "2025-01-01"
        end_date:
          type: string
          format: date
          example: "2025-03-01"
        run_analysis:
          type: boolean
          example: true
      required: [start_date, end_date]
    BackfillFailure:
      type: object
      properties:
        trade_date:
          type: string
          format: date
          example: "2025-02-10"
        stage:
          type: string
          example: ingestion
        reason:
          type: string
          example: binance response not ok
    BackfillResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        start_date:
          type: string
          format: date
        end_date:
          type: string
          format: date
        total_days:
          type: integer
          example: 60
        ingestion_success_days:
          type: integer
          example: 58
        analysis_success_days:
          type: integer
          example: 58
        failure_days:
          type: integer
          example: 2
        analysis_enabled:
          type: boolean
          example: true
        failures:
          type: array
          items:
            $ref: '#/components/schemas/BackfillFailure'
    AnalysisJobResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        trade_date:
          type: string
          format: date
        total_stocks:
          type: integer
          example: 2
        success_count:
          type: integer
          example: 2
        failure_count:
          type: integer
          example: 0
    AnalysisItem:
      type: object
      properties:
        trading_pair:
          type: string
          example: "BTCUSDT"
        market_type:
          type: string
          example: CRYPTO
        close_price:
          type: number
          format: float
          example: 40800.0
        change_percent:
          type: number
          format: float
          example: 0.012
        return_5d:
          type: number
          format: float
          nullable: true
          example: 0.03
        volume:
          type: integer
          example: 190000
        volume_ratio:
          type: number
          format: float
          nullable: true
          example: 1.8
        score:
          type: number
          format: float
          example: 75.5
    AnalysisQueryResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        trade_date:
          type: string
          format: date
        total_count:
          type: integer
          example: 2
        items:
          type: array
          items:
            $ref: '#/components/schemas/AnalysisItem'
    AnalysisHistoryItem:
      type: object
      properties:
        trading_pair:
          type: string
          example: "BTCUSDT"
        market_type:
          type: string
          example: CRYPTO
        trade_date:
          type: string
          format: date
          example: "2025-01-03"
        close_price:
          type: number
          format: float
          example: 40800.0
        change_percent:
          type: number
          format: float
          example: 0.012
        return_5d:
          type: number
          format: float
          nullable: true
          example: 0.03
        volume:
          type: integer
          example: 190000
        volume_ratio:
          type: number
          format: float
          nullable: true
          example: 1.8
        score:
          type: number
          format: float
          example: 75.5
        success:
          type: boolean
          example: true
    AnalysisHistoryResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        symbol:
          type: string
          example: "BTCUSDT"
        start_date:
          type: string
          format: date
        end_date:
          type: string
          format: date
        total_count:
          type: integer
          example: 120
        items:
          type: array
          items:
            $ref: '#/components/schemas/AnalysisHistoryItem'
    ScreenerItem:
      type: object
      properties:
        trading_pair:
          type: string
          example: "BTCUSDT"
        market_type:
          type: string
          example: CRYPTO
        close_price:
          type: number
          format: float
          example: 40800.0
        change_percent:
          type: number
          format: float
          example: 0.012
        return_5d:
          type: number
          format: float
          nullable: true
          example: 0.03
        volume:
          type: integer
          example: 190000
        volume_ratio:
          type: number
          format: float
          nullable: true
          example: 1.8
        score:
          type: number
          format: float
          example: 75.5
    ScreenerResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        trade_date:
          type: string
          format: date
        params:
          type: object
          properties:
            score_min:
              type: number
              format: float
              example: 70
            volume_ratio_min:
              type: number
              format: float
              example: 1.5
            limit:
              type: integer
              example: 50
        total_count:
          type: integer
          example: 2
        items:
          type: array
          items:
            $ref: '#/components/schemas/ScreenerItem'
    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          example: invalid credentials
        error_code:
          type: string
          example: AUTH_INVALID_CREDENTIALS
      required: [success, error, error_code]
