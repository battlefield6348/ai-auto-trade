# 系統架構與設計規範

本文件定義 AI Auto Trade 系統的架構設計、程式碼組織規範及開發標準。

---

## 1. 核心設計原則

### 1.1 三層架構 (3-Layer Architecture)
系統採用經典的三層架構設計，確保職責分離 (Separation of Concerns)：
*   **Handler (介面層)**：處理外部請求（如 HTTP 請求）。負責參數解析、身分驗證，並將請求轉交給 Service 層。
*   **Service (業務邏輯層)**：系統的核心，實作具體的業務流程與規則（如回測邏輯、交易策略判斷）。它不直接操作資料庫，而是透過 Repository 進行資料存取。
*   **Repository (資料存取層)**：負責與外部資料源（如 Postgres, Binance API）互動。封裝 SQL 查詢與外部 SDK 調用，回傳領域模型給 Service 層。

### 1.2 依賴方向 (Dependency Rule)
依賴關係遵循單向遞進：`Handler -> Service -> Repository`。
*   **Handler** 依賴 **Service**。
*   **Service** 依賴 **Repository**。
*   所有層級共享 **Domain Models**（定義於 `internal/domain`），但內層不允許反向依賴外層。

---

## 2. 目錄結構

```
.
├── cmd/
│   └── api/                # 系統進入點，負責 DI 與啟動 Server
├── internal/
│   ├── domain/             # 業務核心（Entity, VO, 定義共享模型）
│   ├── application/        # Service 層 (業務流程與回測執行)
│   ├── interface/          # Handler 層 (HTTP 入口與參數解析)
│   └── infrastructure/     # Repository 層 (DB 操作與外部 API 串接)
├── web/                    # 前端靜態資源 (HTML, CSS, JS)
├── db/                     # 資料庫 Migration 腳本
└── docs/                   # 系統規格與說明文件
```

---

## 3. 重要實作規範

### 3.1 錯誤處理
*   全面使用 Golang 的 `error` 機制。
*   在 Domain 層定義常用的錯誤常數，避免基礎建設層的具體錯誤滲透到內層。

### 3.2 測試策略
*   **單元測試**：Domain 與 Application 層必須具備完整的單元測試，達成邏輯覆蓋。
*   **平行開發**：測試檔應與實作檔放在同一個 package，並以 `_test.go` 命名。

### 3.3 自動化更新紀錄
*   **Migration**：所有的資料庫變更必須透過 `db/migrations` 下的 SQL 腳本執行。
*   **API 規格**：介面變更需同步反映於 `docs/技術規格.md` 與 OpenAPI 文件。

---

## 4. 前後端溝通
*   系統採用 RESTful API 進行溝通。
*   前端 Web Console 直接讀取後端輸出的靜態檔案 (Vite/Vanilla JS)。
*   採用 JWT 進行身分驗證，登入後 Token 儲存於 `localStorage` 或 Cookie。
