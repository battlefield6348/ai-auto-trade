openapi: 3.0.3
info:
  title: AI Auto Trade MVP API
  version: "1.0.0"
  description: |
    MVP 端到端流程的 HTTP API。涵蓋登入、歷史回補（可同步分析）、分析結果查詢與固定條件的強勢股篩選。
servers:
  - url: http://localhost:8080
    description: Local server
tags:
  - name: Health
  - name: Auth
  - name: Ingestion
  - name: Analysis
  - name: Screener
paths:
  /ping:
    get:
      tags: [Health]
      summary: 健康檢查
      responses:
        "200":
          description: pong
          content:
            text/plain:
              schema:
                type: string
                example: pong
  /api/auth/login:
    post:
      tags: [Auth]
      summary: 使用 Email/Password 登入並取得 Access Token
      description: 成功登入後會在回應中帶回 access token，並以 HttpOnly Cookie 寫入 refresh token，方便服務重啟後自動續期。
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        "200":
          description: 登入成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        "401":
          description: 帳密錯誤或帳號未啟用
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/auth/refresh:
    post:
      tags: [Auth]
      summary: 使用 refresh token 續期 access token
      description: 需附帶伺服器簽發的 HttpOnly Cookie `refresh_token`，成功後會回傳新的 access token 並更新 cookie。
      responses:
        "200":
          description: 續期成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        "401":
          description: refresh token 過期或無效
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/auth/logout:
    post:
      tags: [Auth]
      summary: 登出並撤銷 refresh token
      description: 會將 refresh token 標記為失效並清除瀏覽器 Cookie。
      responses:
        "200":
          description: 登出完成
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LogoutResponse'
  /api/admin/ingestion/backfill:
    post:
      tags: [Ingestion]
      summary: 回補指定日期區間的日 K 並可選擇同步分析
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BackfillRequest'
      responses:
        "200":
          description: 執行成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BackfillResponse'
        "400":
          description: 參數錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "401":
          description: 未登入或 token 失效
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "403":
          description: 權限不足（需 admin 或 analyst，且具 ingestion.trigger_backfill）
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/analysis/daily:
    get:
      tags: [Analysis]
      summary: 依日期查詢分析結果
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: trade_date
          required: true
          schema:
            type: string
            format: date
          description: 交易日 (YYYY-MM-DD)
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
        - in: query
          name: offset
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        "200":
          description: 查詢成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnalysisQueryResponse'
        "400":
          description: 參數錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "401":
          description: 未登入或 token 失效
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "404":
          description: 指定日期尚無分析結果
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/analysis/history:
    get:
      tags: [Analysis]
      summary: 查詢指定交易對的歷史分析結果
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: symbol
          schema:
            type: string
            default: BTCUSDT
        - in: query
          name: start_date
          schema:
            type: string
            format: date
        - in: query
          name: end_date
          schema:
            type: string
            format: date
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 1000
        - in: query
          name: only_success
          schema:
            type: boolean
            default: true
      responses:
        "200":
          description: 查詢成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnalysisHistoryResponse'
        "400":
          description: 參數錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "401":
          description: 未登入或 token 失效
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/analysis/backtest:
    post:
      tags: [Analysis]
      summary: 依加權條件回測指定區間的分析結果
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BacktestRequest'
      responses:
        "200":
          description: 回測成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BacktestResponse'
        "400":
          description: 參數錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "401":
          description: 未登入或 token 失效
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /api/analysis/backtest/preset:
    get:
      tags: [Analysis]
      summary: 取得當前使用者的回測條件預設
      security:
        - bearerAuth: []
      responses:
        "200":
          description: 回傳預設（若不存在 success=false）
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  preset:
                    $ref: '#/components/schemas/BacktestRequest'
                  message:
                    type: string
    post:
      tags: [Analysis]
      summary: 儲存回測條件預設
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BacktestRequest'
      responses:
        "200":
          description: 儲存成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
  /api/screener/strong-stocks:
    get:
      tags: [Screener]
      summary: 以固定條件回傳指定日期的強勢股清單
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: trade_date
          required: true
          schema:
            type: string
            format: date
        - in: query
          name: limit
          schema:
            type: integer
            minimum: 1
            maximum: 200
            default: 50
        - in: query
          name: score_min
          schema:
            type: number
            format: float
            default: 70
        - in: query
          name: volume_ratio_min
          schema:
            type: number
            format: float
            default: 1.5
      responses:
        "200":
          description: 查詢成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ScreenerResponse'
        "400":
          description: 參數錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "401":
          description: 未登入或 token 失效
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        "404":
          description: 指定日期尚無分析結果
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    LoginRequest:
      type: object
      properties:
        email:
          type: string
          format: email
          example: user@example.com
        password:
          type: string
          format: password
          example: password123
      required: [email, password]
    LoginResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        access_token:
          type: string
          example: token-id-123
        token_type:
          type: string
          example: Bearer
        expires_in:
          type: integer
          description: 秒數
          example: 1800
        refresh_expires_in:
          type: integer
          description: refresh token 剩餘秒數
          example: 2592000
    LogoutResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: logged out
    BackfillRequest:
      type: object
      properties:
        start_date:
          type: string
          format: date
          example: "2025-01-01"
        end_date:
          type: string
          format: date
          example: "2025-03-01"
        run_analysis:
          type: boolean
          example: true
      required: [start_date, end_date]
    BackfillFailure:
      type: object
      properties:
        trade_date:
          type: string
          format: date
          example: "2025-02-10"
        stage:
          type: string
          example: ingestion
        reason:
          type: string
          example: binance response not ok
    BackfillResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        start_date:
          type: string
          format: date
        end_date:
          type: string
          format: date
        total_days:
          type: integer
          example: 60
        ingestion_success_days:
          type: integer
          example: 58
        analysis_success_days:
          type: integer
          example: 58
        failure_days:
          type: integer
          example: 2
        analysis_enabled:
          type: boolean
          example: true
        failures:
          type: array
          items:
            $ref: '#/components/schemas/BackfillFailure'
    AnalysisItem:
      type: object
      properties:
        trading_pair:
          type: string
          example: "BTCUSDT"
        market_type:
          type: string
          example: CRYPTO
        close_price:
          type: number
          format: float
          example: 40800.0
        change_percent:
          type: number
          format: float
          example: 0.012
        return_5d:
          type: number
          format: float
          nullable: true
          example: 0.03
        volume:
          type: integer
          example: 190000
        volume_ratio:
          type: number
          format: float
          nullable: true
          example: 1.8
        score:
          type: number
          format: float
          example: 75.5
    AnalysisQueryResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        trade_date:
          type: string
          format: date
        total_count:
          type: integer
          example: 2
        items:
          type: array
          items:
            $ref: '#/components/schemas/AnalysisItem'
    AnalysisHistoryItem:
      type: object
      properties:
        trading_pair:
          type: string
          example: "BTCUSDT"
        market_type:
          type: string
          example: CRYPTO
        trade_date:
          type: string
          format: date
          example: "2025-01-03"
        close_price:
          type: number
          format: float
          example: 40800.0
        change_percent:
          type: number
          format: float
          example: 0.012
        return_5d:
          type: number
          format: float
          nullable: true
          example: 0.03
        volume:
          type: integer
          example: 190000
        volume_ratio:
          type: number
          format: float
          nullable: true
          example: 1.8
        score:
          type: number
          format: float
          example: 75.5
        success:
          type: boolean
          example: true
    AnalysisHistoryResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        symbol:
          type: string
          example: "BTCUSDT"
        start_date:
          type: string
          format: date
        end_date:
          type: string
          format: date
        total_count:
          type: integer
          example: 120
        items:
          type: array
          items:
            $ref: '#/components/schemas/AnalysisHistoryItem'
    BacktestRequest:
      type: object
      properties:
        symbol:
          type: string
          example: BTCUSDT
        start_date:
          type: string
          format: date
          example: "2025-01-01"
        end_date:
          type: string
          format: date
          example: "2025-12-31"
        weights:
          type: object
          properties:
            score:
              type: number
              format: float
              example: 1
            change_bonus:
              type: number
              format: float
              example: 10
            volume_bonus:
              type: number
              format: float
              example: 10
            return_bonus:
              type: number
              format: float
              example: 8
            ma_bonus:
              type: number
              format: float
              example: 5
        thresholds:
          type: object
          properties:
            total_min:
              type: number
              format: float
              example: 60
            change_min:
              type: number
              format: float
              example: 0.005
            volume_ratio_min:
              type: number
              format: float
              example: 1.2
            return5_min:
              type: number
              format: float
              example: 0.01
              description: 近 5 日報酬率門檻
            ma_gap_min:
              type: number
              format: float
              example: 0.01
              description: 收盤相對 MA20 的乖離率門檻
        flags:
          type: object
          properties:
            use_change:
              type: boolean
              default: true
            use_volume:
              type: boolean
              default: true
            use_return:
              type: boolean
              default: false
            use_ma:
              type: boolean
              default: false
          description: 選擇要啟用的加分條件（未啟用者視同不計分）
        horizons:
          type: array
          items:
            type: integer
          example: [3, 5, 10]
      required: [start_date, end_date]
    BacktestEvent:
      type: object
      properties:
        trading_pair:
          type: string
          example: BTCUSDT
        trade_date:
          type: string
          format: date
          example: "2025-03-01"
        close_price:
          type: number
          format: float
          example: 50200.0
        change_percent:
          type: number
          format: float
          example: 0.012
        return_5d:
          type: number
          format: float
          nullable: true
          example: 0.03
        ma_gap:
          type: number
          format: float
          nullable: true
          description: 收盤相對 MA20 的乖離率（例 0.01=+1%）
        volume_ratio:
          type: number
          format: float
          nullable: true
          example: 1.8
        score:
          type: number
          format: float
          example: 75
        total_score:
          type: number
          format: float
          example: 95
        components:
          type: object
          additionalProperties:
            type: number
            format: float
        forward_returns:
          type: object
          additionalProperties:
            type: number
            format: float
            nullable: true
          example:
            d3: 0.012
            d5: -0.01
            d10: 0.035
    BacktestResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        symbol:
          type: string
          example: BTCUSDT
        start_date:
          type: string
          format: date
        end_date:
          type: string
          format: date
        total_events:
          type: integer
          example: 12
        config:
          type: object
        events:
          type: array
          items:
            $ref: '#/components/schemas/BacktestEvent'
        stats:
          type: object
          properties:
            returns:
              type: object
              additionalProperties:
                type: object
                properties:
                  avg_return:
                    type: number
                    format: float
                    example: 0.012
                  win_rate:
                    type: number
                    format: float
                    example: 0.55
    ScreenerItem:
      type: object
      properties:
        trading_pair:
          type: string
          example: "BTCUSDT"
        market_type:
          type: string
          example: CRYPTO
        close_price:
          type: number
          format: float
          example: 40800.0
        change_percent:
          type: number
          format: float
          example: 0.012
        return_5d:
          type: number
          format: float
          nullable: true
          example: 0.03
        volume:
          type: integer
          example: 190000
        volume_ratio:
          type: number
          format: float
          nullable: true
          example: 1.8
        score:
          type: number
          format: float
          example: 75.5
    ScreenerResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        trade_date:
          type: string
          format: date
        params:
          type: object
          properties:
            score_min:
              type: number
              format: float
              example: 70
            volume_ratio_min:
              type: number
              format: float
              example: 1.5
            limit:
              type: integer
              example: 50
        total_count:
          type: integer
          example: 2
        items:
          type: array
          items:
            $ref: '#/components/schemas/ScreenerItem'
    ErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: string
          example: invalid credentials
        error_code:
          type: string
          example: AUTH_INVALID_CREDENTIALS
      required: [success, error, error_code]
