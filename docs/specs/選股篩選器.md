# 強勢交易對篩選器（Screener）功能規格

版本：v1.0  
狀態：草稿  
最後更新：2025-12-02

---

## 1. 功能簡介

本文件定義「強勢交易對篩選器（Screener）」之產品需求與行為規格，現聚焦於 BTC/USDT。

選股器的目標：  
基於「分析結果」資料，讓使用者能以條件組合的方式，快速找到符合特定特徵的交易對（目前僅 BTC/USDT），例如：

- 近 5 日強勢且量能放大
- 接近前高且均線多頭
- 低波動整理後突破

本功能屬於整個系統的上層核心功能，直接面向使用者，也為後續策略、排程通知與報告輸出打下基礎。

---

## 2. 範圍與非範圍

### 2.1 功能範圍（In Scope）

- 使用「條件組合」來篩選全市場的分析結果
- 支援邏輯運算（AND / OR）
- 支援多類型條件：
  - 數值條件（大於、小於、介於）
  - 類別條件（市場、產業）
  - 標籤（tags）條件
  - 排序與分頁
- 支援「選股模板」（預設策略組合）
- 支援「使用者自訂條件」保存（内部版本）
- 與查詢介面整合（Query & Export）

### 2.2 非範圍（Out of Scope）

- 多層次布林邏輯（如 AND/OR 巢狀條件）
- 即時盤中選股（v1 僅使用分析結果，為日階層）
- 對外帳號／使用者登入系統（僅設計，不實作）

---

## 3. 前置條件與依賴

本功能需依賴：

- 日批次分析核心（Daily Batch Analysis Core）
- 分析結果查詢與輸出介面（Query & Export）

選股器本質上即是 Query & Export 的「高階使用介面」，因此所有條件均以分析結果欄位為基礎。

---

## 4. 使用情境與角色

### 4.1 使用情境

1. 使用者希望快速找到「今日強勢交易對」（BTC/USDT），使用預設模板。
2. 使用者希望找到「近 20 日報酬 > 10% 且均線多頭排列」的交易對（預留未來多交易對）。
3. 使用者想搜尋「量能放大」的交易對。
4. 研究人員想建立自訂選股條件，重複套用。
5. 後端系統依選股器條件，每日產生固定清單並匯出。

### 4.2 使用者角色

- 普通使用者（前端 UI）
- 研究人員（內部）
- 策略服務（內部）

---

## 5. 選股條件模型（Condition Model）

選股器必須能表示各種條件，需具備「統一結構、可組合」。

### 5.1 基本條件類型

Screener 需至少支援以下五大類：

#### 類型 A：數值條件（Numeric Condition）

針對分析結果中的數值欄位：

- 收盤價
- 近 5 日報酬
- 近 20 日報酬
- 近 60 日報酬
- 成交量放大倍率
- 均線乖離率
- 分數（score）
- 波動度

支援運算：

- 大於（>）
- 小於（<）
- 介於（between）
- 大於等於（>=）
- 小於等於（<=）

#### 類型 B：類別條件（Category Condition）

針對具有分類意義的欄位（目前簡化為 market_type=CRYPTO，預留多交易對）：

支援：

- 等於（=）
- 多選（IN）

#### 類型 C：標籤（Tags）條件

例如：

- 必須包含以下任一標籤：
  - 量能放大
  - 短期強勢
- 必須同時包含多項標籤
- 必須「不包含」某些標籤（例如排除高波動）

#### 類型 D：文字匹配（Text Condition）（可選）

- 股票名稱包含某關鍵字（例如搜尋公司名）
- 但此功能可視 v1 是否需要，初版可不強制

#### 類型 E：股票代碼列表條件（ID List Condition）

允許使用者直接輸入股票代碼列表：

- [2330, 2303, 3034]
- 支援 include / exclude


---

## 6. 邏輯運算

### 6.1 單層布林邏輯（v1）

v1 規範使用：

- AND（所有條件需同時成立）
- OR（任一條件成立）

但為避免複雜度爆炸：

- 不支援巢狀結構（no nested AND/OR）
- 支援單一層組合，例如：
(A AND B AND C)
(A OR B OR C)
(A AND B) OR C


可支援「線性序列表達」，由 Query Engine 按順序解析。

### 6.2 未來擴充（v2）

可考慮引入：

- 條件群組（group logic）
- 巢狀布林邏輯樹（AND groups inside OR groups）

---

## 7. 選股模板（Preset Templates）

為降低使用者成本，系統需內建一組常用模板：

### 7.1 必備模板（v1）

1. **短期強勢股**
   - 近 5 日報酬 > 某門檻（例如 5%）
   - 當日位在近 20 日區間上半部
   - 排除成交量極低股票

2. **量能放大股**
   - 成交量放大倍率 > 某值（例如 2 倍）
   - 近 5 日報酬為正

3. **多頭排列突破**
   - 均線：MA5 > MA10 > MA20
   - 當日收盤價突破近 20 日高點

4. **低波動蓄勢**
   - 近 20 日波動度低於某門檻
   - 位於均線附近整理（乖離率小）

5. **接近前高**
   - 當日收盤價位於近 20 日高點的 80% 以上

### 7.2 模板行為需求

- 每個模板需有「條件列表」與「排序方式」
- 模板需可被複製後修改，成為使用者自訂條件
- 模板需有版本（供未來調整條件使用）

---

## 8. 執行行為與查詢流程

選股器實際是「對 Query Engine 的高階封裝」，流程如下：

1. 使用者帶入條件（或選擇模板）
2. 選股器將條件轉換為標準化 Query Model
3. 調用 Query Engine（即 /docs/specs/查詢與匯出.md 所定義的查詢介面）
4. 取得篩選結果列表
5. 依排序規則排序
6. 分頁回傳

### 8.1 輸入

- 日期（必填）
- 條件列表
- 運算邏輯（AND/OR）
- 排序欄位與方向
- 分頁資訊

### 8.2 輸出

- 符合條件之股票列表
- 每檔股票需至少包含：
  - 股票代碼
  - 股票名稱
  - 市場別
  - 產業別
  - 當日收盤價
  - 分數
  - 主要指標摘要（如 5 日/20 日報酬、放大倍率等）
  - 標籤列表
- 分頁資訊（總筆數、頁碼、頁數等）

---

## 9. 錯誤處理與限制

### 9.1 異常處理

若條件不合法需回報清楚的錯誤類型：

- 不支援的欄位
- 運算子錯誤
- 數值範圍不合法
- AND/OR 混合但順序不正確
- 超出系統最大返回數

### 9.2 系統限制

- 單次查詢最大回傳筆數（例如 500）
- 單次最多條件數（例如 20 個）
- 單次最多多選值（例如產業別最多 10 項）

---

## 10. 非功能性需求

### 10.1 效能

- 一般選股查詢應可在合理硬體下於 500ms 內完成
- 多條件複雜查詢應可在 1–2 秒內完成

### 10.2 可擴充性

- 從模板到自訂策略的邏輯應一致
- 未來可新增新指標、新條件類型，而不影響既有行為

### 10.3 可觀測性

需紀錄：

- 使用者最常用的選股條件
- 最常用的模板
- 查詢耗時統計

---

## 11. 開發與測試重點

### 11.1 開發重點

1. 定義標準化條件結構（Condition Model）
2. AND/OR 單層邏輯解析器
3. 將條件轉換為 Query Engine 可理解的格式
4. 排序與分頁能力
5. 內建模板與版本化

### 11.2 測試建議

- 單元測試：
  - 條件解析（輸入 → Condition Model）
  - AND/OR 組合結果
  - 篩選行為與邏輯正確性
- 整合測試：
  - 與 Query Engine 串接後的完整選股流程
- 邊界測試：
  - 空條件（應視為全市場）
  - 極值條件（例如成交量放大倍率 > 100）
  - 多項標籤同時存在與排除

---

## 12. 未來擴充（非 v1）

- 支援巢狀布林邏輯（group priority）
- 支援回測（將選股條件在歷史資料套用）
- 支援「動態模板」，由系統自動調整參數（如市況變化）
- 觸發式通知（選股結果變化時提醒）

