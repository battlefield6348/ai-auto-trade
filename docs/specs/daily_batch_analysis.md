# 日批次分析核心（Daily Batch Analysis Core）功能規格

版本：v1.0  
狀態：草稿  
最後更新：2025-12-02

---

## 1. 功能簡介

本文件定義「日批次分析核心（Daily Batch Analysis Core）」之產品需求與行為規格，作為後端系統實作與測試依據。

本功能目標：  
在「每日資料已成功寫入」的前提下，對所有台灣股票進行標準化的批次分析計算，產生結構化的分析結果，供後續：

- 報表輸出
- 排行榜 / 篩選器
- 策略模組
- 對外 API

等功能使用。

---

## 2. 範圍與非範圍

### 2.1 功能範圍（In Scope）

- 針對「日 K」與「基本資料」，進行每日一次的批次分析：
  - 計算常用技術指標（例如移動平均線、振幅、成交量變化等）
  - 產生每檔股票的當日分析結果與標籤（tags）
  - 產生可排序、可篩選的「分數 / 排名」基礎欄位
- 支援全市場批次分析，以及部分股票重跑分析
- 分析結果的統一資料結構與儲存
- 分析任務的排程與錯誤處理
- 對內提供「分析結果查詢」介面需求（行為層面）

### 2.2 非功能範圍（Out of Scope，在 v1 不處理）

- 複雜量化交易策略（多因子模型、最佳化組合等）
- 盤中即時計算（本文件僅定義「日終批次」）
- 對外使用者介面（前端、報表 UI）
- 自動下單、交易相關功能
- 回測框架（可於未來獨立為另一規格文件）

---

## 3. 前置條件與依賴

### 3.1 依賴功能

本功能依賴以下前置條件：

- 「台灣股票資料取得（Data Ingestion）」已正常運作，且每日例行抓取已完成：
  - 目標交易日之日 K 資料已寫入儲存層
  - 股票基本資料可查詢
- 可透過統一介面查詢：
  - 單檔股票在指定日期區間的日 K 序列
  - 當日整體市場的股票清單與基本資料

### 3.2 分析時間點（台北時間）

- 正式環境：預設於每個交易日的 **19:30** 啟動日批次分析任務。
- 執行前需確認：
  - 當日的 Data Ingestion 任務已標記為成功或部分成功
- 若 19:30 任務未執行或失敗，可重試：
  - 第一次重試：20:00
  - 第二次重試：20:30

---

## 4. 使用情境與角色

### 4.1 角色定義

- 系統運維/工程師
  - 監控批次分析任務狀態
  - 針對失敗或異常情況觸發重跑
- 下游分析/查詢模組
  - 讀取分析結果，用於排序、篩選、策略判斷等
- 未來前端 / 報表服務
  - 透過對內介面取得分析結果並呈現給終端使用者

### 4.2 主要使用情境

1. 每個交易日晚上，系統自動對全市場股票跑一次分析，產出完整的「當日分析結果快照」。
2. 針對某些股票因資料修正或補抓，需要重跑該股票在某些日期的分析結果。
3. 未來前端要顯示「今日強勢股」、「成交量放大排行榜」等，皆直接查本分析結果。

---

## 5. 分析輸入與輸出定義

### 5.1 分析輸入

對於每檔股票，在進行「某一交易日 D」的分析時，最少需要以下資料：

1. 該股票在日期 D 的日 K 資料：
   - 開、高、低、收、成交量、成交金額等
2. 該股票在 D 之前的歷史日 K 序列（用於計算多日指標）：
   - 例如過去 120 個交易日（具體長度可配置，但 v1 建議至少 120 日）
3. 股票基本資料：
   - 市場別（上市/上櫃）
   - 產業別
   - 股票狀態（正常/下市等）
   - 種類（一般股/ETF/債券等，若可區別）

> 若輸入資料不完整或不符合基本驗證規則，則該股票該日的分析結果需標記為失敗並記錄原因。

### 5.2 分析輸出（分析結果資料結構）

每檔股票 × 每個交易日，需產生一筆「分析結果」資料，包含：

1. 基本欄位
   - 股票代碼
   - 交易日期
   - 市場別
   - 產業別
   - 執行分析時的版本資訊（可用來區分不同分析公式版本）

2. 價格與報酬相關欄位（例示，實際公式由工程實作細節決定）
   - 當日收盤價
   - 當日漲跌價差
   - 當日漲跌幅
   - 近 N 日報酬：
     - 近 5 日報酬
     - 近 20 日報酬
     - 近 60 日報酬
   - 近 N 日高低價區間：
     - 近 20 日最高價
     - 近 20 日最低價
     - 當日收盤價相對於近 20 日區間的位置（百分比）

3. 技術指標類欄位（v1 建議最小集合，可日後擴充）
   - 短中長期移動平均：
     - MA5、MA10、MA20、MA60
   - 價格與均線關係：
     - 收盤價相對 MA20 的乖離率
     - 多條均線的排列狀態簡易標記（例如多頭排列、空頭排列、糾結）
   - 成交量相關：
     - 當日成交量
     - 近 5 日平均成交量
     - 成交量放大倍率（相對近 N 日均量）

4. 風險 / 振幅相關欄位（簡易版）
   - 當日振幅（高低價差 / 昨日收盤價）
   - 近 20 日平均振幅
   - 近 60 日價格標準差或類似波動度指標（若計算成本允許）

5. 分數與標籤（tags）
   - 綜合分數（簡單可解釋）：
     - 例如將「近期報酬、成交量放大、均線多頭」等指標加權後產生一個整體分數
   - 類別標籤（可多個）：
     - 「短期強勢」
     - 「量能放大」
     - 「接近前高」
     - 「創近 20 日新高 / 新低」
     - 「整理中」等
   - 以上標籤規則需明確定義（見第 6 節）

6. 狀態欄位
   - 分析是否成功（成功 / 失敗）
   - 若失敗，錯誤類型（輸入缺失 / 計算錯誤等）
   - 執行時間戳記

> 註：本文件不規範實際欄位名稱與資料型別，由工程實作時決定，但邏輯欄位需能對應。

---

## 6. 分析邏輯需求（規則層級）

本節定義「需要有什麼分析邏輯」，而非具體數學公式或程式實作。公式細節可由工程與量化人員討論後細化。

### 6.1 報酬與區間位置

1. 近 N 日報酬計算
   - 需支援至少：
     - 近 5 日
     - 近 20 日
     - 近 60 日
   - 意義：提供短中期漲跌狀態作為排序、篩選依據。

2. 區間位置
   - 以近 20 日為基本視窗：
     - 計算當日收盤價在「近 20 日最高與最低價」之間的位置百分比。
   - 用途：
     - 區分「接近前高」、「接近前低」、「在區間中段」等狀態。

### 6.2 均線與趨勢

1. 均線需求
   - 至少計算 MA5、MA10、MA20、MA60。
   - Validity：
     - 若歷史資料不足以計算某一均線，需標記該欄位為無法計算，而非產生錯誤結果。

2. 均線排列狀態
   - 簡化為幾種常見分類，例如：
     - 多頭排列（短期均線 > 中期 > 長期）
     - 空頭排列（短期均線 < 中期 < 長期）
     - 其他（糾結或不明顯）
   - 用途：
     - 產生簡單可讀的「趨勢標籤」。

3. 乖離程度
   - 收盤價相對某均線（例如 MA20）的乖離率。
   - 配合標籤：
     - 過度乖離時，可標示為「偏離均值過大」，提供風險提示。

### 6.3 成交量與活躍度

1. 成交量均值
   - 至少計算近 5 日（短期）與近 20 日（中期）的平均成交量。

2. 成交量放大 / 萎縮
   - 當日成交量 vs 近 N 日平均量的倍率。
   - 根據倍率區間，給予標籤：
     - 量能明顯放大
     - 量能萎縮
     - 正常範圍

3. 最小活躍度條件（可選）
   - 若股票成交量長期極低，可標記為「流動性不足」，供後續篩選用。

### 6.4 標籤（Tags）規則

標籤需具備：

- 計算規則可被描述與重現
- 可被下游系統用於篩選、排序

範例（v1 建議集合）：

1. 「短期強勢」
   - 條件示意：
     - 近 5 日報酬大於某一門檻，且當日收盤價接近近 20 日高點。
2. 「中期強勢」
   - 近 20 日或 60 日報酬為正，且均線呈多頭排列。
3. 「量能放大」
   - 當日成交量 ≥ 近 20 日平均量的某倍率。
4. 「接近前高」
   - 當日收盤價大於近 20 日區間位置的某比例（例如 80% 以上）。
5. 「接近前低」
   - 當日收盤價低於近 20 日區間位置的某比例（例如 20% 以下）。
6. 「高波動」
   - 近 20 日平均振幅或波動度高於某門檻。
7. 「低波動」
   - 近 20 日平均振幅或波動度低於某門檻。

> 實際門檻值、次序與組合可由工程與策略制定者再行調整，本文件先要求「必須有此類標籤能力」。

### 6.5 綜合分數（Score）

- 目的：
  - 提供一個簡單可排序的數值，讓下游功能可以依此產生排行榜。
- 要求：
  - 分數應由多個維度組合而成，如：
    - 報酬表現
    - 成交量變化
    - 趨勢狀態
    - 波動度
  - 分數規模（例如 0–100 分）可自行定義，但需：
    - 穩定
    - 可重算（同樣輸入 → 同樣分數）
- 未來擴充：
  - 需可以引入不同版本的打分模型（透過版本欄位記錄）。

---

## 7. 任務排程與執行流程

### 7.1 日批次分析流程概觀

1. 確認目標交易日 D
2. 檢查該日 Data Ingestion 任務狀態：
   - 若為失敗 → 本任務可選擇不執行或標記為整體失敗（v1 可直接標記為失敗）。
   - 若為部分成功 → 照常執行，但對於缺失股票會產生失敗記錄。
3. 取得當日股票清單（可過濾下市、停牌等狀態）。
4. 依股票為單位進行分析計算：
   - 取得必要輸入（當日及歷史日 K、基本資料）
   - 若輸入不足，標記該股票分析失敗
   - 否則執行分析邏輯，產生分析結果
5. 批次寫入分析結果儲存層
6. 統計整體任務結果（成功數、失敗數等）
7. 寫入任務紀錄，供監控與重跑使用。

### 7.2 重跑機制

需支援兩種重跑方式：

1. 以「日期」為主：
   - 針對某一交易日，重新跑全市場或部份股票分析。
2. 以「股票 × 日期區間」為主：
   - 例如：指定某檔股票在某段日期重算分析結果（運維修補用）。

重跑時要求：

- 可以選擇是否覆蓋既有分析結果（預設覆蓋）。
- 若原資料已更新（例如回補日 K 資料），重跑後結果需與新資料一致。

---

## 8. 儲存與查詢需求

### 8.1 儲存層需求

- 能支援以下查詢模式：
  1. 依「日期」查詢當日全市場或某市場的分析結果。
  2. 依「股票代碼 + 日期區間」查詢該股歷史分析結果。
  3. 依特定條件篩選：
     - 產業別
     - 市場別
     - 分數區間
     - 特定標籤（例如「短期強勢」且「量能放大」）。
- 分析結果應有索引：
  - 至少以「日期」與「股票代碼」為索引鍵之一。

> 實際資料庫種類與 schema 命名不在本文件範圍內。

### 8.2 對內介面需求（供其他模組使用）

介面需支援：

1. 查詢某一日期 D 的排行列表：
   - 可依「分數」、「近 N 日報酬」、「成交量放大倍率」等欄位排序。
   - 支援條件篩選（市場別、產業別、標籤等）。

2. 查詢單一股票歷史分析軌跡：
   - 回傳指定日期區間的分析結果列表，用於繪圖或研究。

3. 查詢特定標籤組合：
   - 例如：取得「短期強勢」且「量能放大」且「產業為半導體」的股票清單。

> 本文件只要求「能做到上述查詢行為」，不限制其為函式、API 或其他形式。

---

## 9. 監控與紀錄

### 9.1 任務層級紀錄

每次批次任務需紀錄：

- 任務類型（每日例行 / 重跑）
- 目標日期
- 任務開始時間、結束時間
- 總股票數
- 分析成功數、失敗數
- 整體狀態（成功 / 部分成功 / 失敗）
- 任務版本（以便追蹤分析公式變更）

### 9.2 股票層級錯誤紀錄

對於分析失敗的股票 × 日期，需紀錄：

- 股票代碼
- 交易日期
- 失敗原因分類：
  - 輸入資料不足
  - 輸入資料驗證失敗
  - 計算邏輯錯誤
  - 其他（需附文字說明）

---

## 10. 非功能性需求

### 10.1 效能

- 目標：在合理硬體資源下，對全市場股票（上市+上櫃）完成一日分析的時間建議不超過 30 分鐘。
- 可採分批、併發等方式達成，但不得影響資料庫與其他核心服務的穩定性。

### 10.2 可靠性

- 任務不可默默失敗，需有紀錄可查。
- 若部分股票無法分析，不得影響其他股票的分析結果寫入。

### 10.3 可擴充性

- 未來可能新增：
  - 更多技術指標
  - 基本面指標（如 EPS、營收成長）
  - 法人籌碼、籌碼集中度等
- 現有設計需能增欄位、改打分模型，而不破壞既有資料查詢與使用。

---

## 11. 開發與測試重點

### 11.1 開發優先順序（給工程師與 Codex 的方向）

優先完成：

1. 分析任務排程與輸入資料讀取流程
2. 最小集合的技術指標與報酬欄位
3. 基礎標籤（短期強勢、量能放大、接近前高/前低）
4. 分析結果儲存與基礎查詢介面

之後再擴充：

- 更多指標與標籤
- 更複雜的打分模型

### 11.2 測試建議

- 單元測試：
  - 個別指標計算邏輯（使用固定輸入驗證輸出）
  - 標籤判斷邏輯
- 整合測試：
  - 針對一小組股票，模擬完整「資料取得 → 分析 → 查詢」流程。
- 邊界情境：
  - 歷史資料不足時的處理
  - 成交量極低或價格異常波動時是否穩定運作。

