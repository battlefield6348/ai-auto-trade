# 策略引擎（Strategy Engine）功能規格

版本：v1.0  
狀態：草稿  
最後更新：2025-12-02

---

## 1. 功能簡介

本文件定義「策略引擎（Strategy Engine）」之產品需求與行為規格。

策略引擎的目標：

- 讓使用者或內部系統能以「邏輯組合」方式定義策略
- 可設定策略的觸發條件、觸發頻率、時間點與追蹤規則
- 當策略條件成立時，執行一段「動作」（例如：通知、匯出、觸發 webhook）
- 支援複雜度高於 Screener 與 Notification 的邏輯層

此功能是整個股票分析平台的「智慧層」，可逐步延伸至：

- 短線策略
- 量化策略
- 偵測異常的 AI rule-based 判斷
- 甚至未來接外部交易 API（非本階段）

---

## 2. 範圍與非範圍

### 2.1 功能範圍（In Scope）

- 策略定義（Strategy Definition）
- 策略條件（Strategy Conditions）
- 策略動作（Strategy Actions）
- 策略執行排程（每日或自訂）
- 策略狀態追蹤（Active/Inactive/Triggered）
- 與選股器整合（Screener-based conditions）
- 支援「跨日」策略（需要前後日比較）
- 支援「股票 × 多日資料」策略（如連續 n 天成立）
- 支援「產業層級」策略（如整體產業強於大盤）

### 2.2 非範圍（Out of Scope）

- 即時盤中策略（v1 僅在日階層）
- 自動下單（不在本階段範圍）
- 複雜 AI 模型（可未來擴充）

---

## 3. 前置條件與依賴

策略引擎依賴：

- 選股器（Stock Screener）
- 通知系統（Alert/Notification Engine）
- 分析結果查詢介面（Query & Export）

---

## 4. 策略組成

策略由三個主要部分構成：

1. **條件（Condition）**  
2. **狀態（State）**  
3. **動作（Action）**

---

## 5. 策略條件模型（Strategy Condition Model）

策略條件需支援 Screener 的所有條件，但還要更強：

### 5.1 單日條件（Day Condition）

與 Screener 相同：

- 當日近 5 日報酬 > X%
- 當日成交量放大倍率 > N
- 當日標籤包含什麼
- 當日股價突破什麼

### 5.2 跨日條件（Multi-Day Condition）

策略可要求：

- **條件需連續成立 n 天**
  - 例：近 3 天成交量均大於均量 2 倍  
- **條件需首次突破**
  - 例：今日收盤首次突破近 20 日高點  
- **條件需由未成立 → 成立的轉折**
  - 例：今日收盤價從均線下方穿越到均線上方（Golden Cross）

### 5.3 組合條件（Composite Condition）

策略可表示：

- （A AND B）  
- （A OR B）  

但 v1 不支援巢狀條件（與選股器一致）。

### 5.4 產業與市場層級條件

策略可比較：

- 產業平均報酬 vs 大盤報酬  
- 產業量能 vs 大盤量能  
- 某產業內符合條件的股票數量 > K（常見於族群輪動策略）

### 5.5 自訂計算條件（v1 可選）

可允許使用簡單運算：

- （近 5 日報酬） - （大盤近 5 日報酬） > X%
- （均線乖離率 MA20）×（量能比） > 某值

此項可視 v1 是否需要，若未立即需要可先不實作。

---

## 6. 策略動作（Strategy Actions）

策略被觸發後可執行的動作：

### 6.1 必備動作

- 發送通知（Email/Webhook）
- 儲存策略觸發結果（寫入歷史表）
- 匯出觸發股票清單（CSV 或等價格式）

### 6.2 未來擴充動作（v2+）

- 播放特定提示（前端）
- 傳送到策略監控儀表板
- 呼叫外部 API（例如 Slack/Line 通知）
- 偵測結果後執行「下一步策略」（策略串接）

---

## 7. 策略執行排程（Execution Schedule）

策略需定期執行：

- 預設：每日分析結果出爐後，由系統執行  
- 每日執行時間：建議 **20:15–20:30**

策略也可設定：

- 執行頻率（例如每 1 天、每 3 天）
- 僅在交易日執行
- 自動跳過資料不完整之日期

---

## 8. 策略狀態（Strategy State）

每個策略需維護以下狀態：

- **Active**（啟用）
- **Inactive**（停用）
- **Triggered**（今日已觸發，避免重複）
- **History**（過去觸發紀錄）

策略需有：

- 建立時間
- 修改時間
- 最新觸發時間
- 已觸發次數計數器

---

## 9. 策略引擎執行流程

每日執行流程：

1. 取得所有 Active 策略  
2. 依序處理策略（需隔離錯誤，不能一個策略 crash 其他）
3. 對每個策略：
   - 讀取策略條件
   - 依條件查詢分析結果（透過選股器或 Query Engine）
   - 若為跨日條件，需讀取歷史資料
   - 計算條件是否成立
4. 若條件成立：
   - 記錄觸發
   - 執行動作（通知、匯出…）
5. 更新策略狀態
6. 寫入策略執行紀錄（每日一筆）

---

## 10. 策略管理（Strategy Management）

提供功能讓使用者：

### 10.1 建立策略

使用者需能設定：

- 策略名稱
- 策略描述
- 策略條件（可含跨日邏輯）
- 策略動作（通知 / 匯出 / webhook）
- 策略排程（每日、自訂頻率）
- 啟用/停用開關

### 10.2 編輯策略

- 修改條件
- 修改動作
- 修改排程

### 10.3 停用策略

- 停用後不再執行，但資料保留

### 10.4 刪除策略

- 移除策略全部設定與歷史紀錄（可選）

---

## 11. 儲存需求

需儲存：

1. 策略定義（Strategy Definition）
2. 策略條件（JSON 結構）
3. 策略動作
4. 狀態（Active/Triggered）
5. 策略歷史紀錄（帶入哪些股票被觸發）

---

## 12. 查詢功能

需支援查詢：

- 使用者全部策略清單
- 單一策略詳細內容
- 策略當日是否觸發
- 策略歷史觸發紀錄（含日期與股票清單）

---

## 13. 系統健康擴充（內部）

策略引擎本身也需能：

- 偵測自身執行異常
- 偵測異常耗時
- 當策略執行出現錯誤過多時發送 internal alert（依賴通知系統）

---

## 14. 非功能性需求

### 14.1 效能

- v1 預期處理數十至數百個策略  
- 每個策略需在 0.3–2 秒內完成執行（依複雜度）

### 14.2 穩定性

- 單一策略失敗不可中止全部策略
- 所有策略需在當日固定時間內執行完畢（例如 20:30 前）

### 14.3 可擴充性

- 需可增加新條件類型（如基本面指標、法人買賣超…）
- 動作可新增（如多層策略串接）

---

## 15. 開發與測試重點

### 15.1 開發重點

1. 策略條件解析器（含跨日條件）
2. 策略執行排程器
3. 與 Screener / Query Engine 整合
4. 策略動作執行器（Notification / Export / Webhook）
5. 策略狀態管理

### 15.2 測試建議

- 單元測試：
  - 跨日條件（連續成立 N 天）
  - 首次突破
  - 趨勢反轉（下穿、上穿）
- 整合測試：
  - 多策略同時執行
  - 執行流程快照測試
- 邊界測試：
  - 無資料情況
  - 過多股票命中情況（需正確縮減至通知內容上限）

---

## 16. 未來擴充（非 v1）

- 盤中策略（1 分鐘 K / 5 分鐘 K）
- AI/ML 自動策略生成
- 策略回測引擎
- 交易 API 連動（非本階段）
